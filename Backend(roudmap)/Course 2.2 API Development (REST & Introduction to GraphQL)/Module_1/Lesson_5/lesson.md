## 🌐 الوحدة 1: مبادئ وتصميم واجهات RESTful API

### 📘 الدرس 5: المصادقة والتخويل في واجهات API

#### 🧠 **ماذا ستتعلم**
* الفرق الجوهري بين المصادقة (Authentication) والتخويل (Authorization).
* لماذا المصادقة عديمة الحالة (Stateless Authentication) مهمة لواجهات RESTful API.
* نظرة عامة على استراتيجية المصادقة القائمة على التوكن (Token-based).
* كيف يتم استخدام التوكن في ترويسة `Authorization`.

---
### 🔑 1. المصادقة مقابل التخويل (Authentication vs. Authorization)
هذان مفهومان أساسيان في الأمان وغالبًا ما يتم الخلط بينهما.

* **المصادقة (Authentication - "من أنت؟"):** هي عملية **التحقق من هوية** المستخدم. هذا هو الجزء الذي تثبت فيه أنك من تدعي أنك هو، عادةً عن طريق تقديم اسم مستخدم وكلمة مرور. إنها عملية "تسجيل الدخول".

* **التخويل (Authorization - "ماذا يمكنك أن تفعل؟"):** هي عملية **التحقق من الصلاحيات** التي يمتلكها المستخدم. تحدث هذه العملية *بعد* نجاح المصادقة. هي تحدد ما إذا كان للمستخدم المصادق عليه الحق في الوصول إلى مورد معين أو تنفيذ إجراء معين (على سبيل المثال، هل هذا المستخدم "مدير" أم "مستخدم عادي"؟).

> **ببساطة:** تخيل أنك في المطار. **المصادقة** هي عندما تُظهر جواز سفرك لموظف الجوازات ليتحقق من هويتك. **التخويل** هو عندما يُسمح لك بالصعود إلى طائرة معينة فقط (وليس أي طائرة تريدها) بناءً على بطاقة الصعود التي تحملها.

---
### 🕊️ 2. المصادقة عديمة الحالة (Stateless Authentication)
كما تعلمنا، أحد مبادئ REST الأساسية هو **انعدام الحالة (Statelessness)**، أي أن الخادم لا يخزن أي معلومات عن جلسة العميل. هذا يعني أن الطرق التقليدية التي تعتمد على الجلسات (Sessions) على الخادم ليست مثالية.

**الحل هو المصادقة القائمة على التوكن (Token-based Authentication):**
1.  يقوم العميل بتسجيل الدخول مرة واحدة باستخدام بيانات اعتماده.
2.  يرد الخادم بـ "توكن" (Token)، وهو سلسلة نصية فريدة وموقعة.
3.  يقوم العميل بحفظ هذا التوكن.
4.  مع **كل طلب لاحق** إلى مسار محمي، يقوم العميل بإرفاق هذا التوكن.
5.  يقوم الخادم بالتحقق من صحة التوكن مع كل طلب لتحديد هوية المستخدم وصلاحياته، دون الحاجة إلى تذكر أي شيء عن الجلسة.

---
### 🎟️ 3. المصادقة القائمة على التوكن (JWT كمثال)
**JWT (JSON Web Token)** هو المعيار الأكثر شيوعًا لإنشاء التوكن في تطبيقات الويب الحديثة.

**كيف يعمل تدفق JWT:**
1.  **تسجيل الدخول:** يرسل المستخدم `email` و `password` إلى نقطة نهاية `/login`.
2.  **التحقق:** يتحقق الخادم من صحة بيانات الاعتماد.
3.  **إنشاء التوكن:** إذا كانت البيانات صحيحة، يقوم الخادم بإنشاء توكن JWT يحتوي على معلومات المستخدم (مثل `userId`) ويقوم بتوقيعه رقميًا باستخدام مفتاح سري.
4.  **إرسال التوكن:** يرسل الخادم التوكن مرة أخرى إلى العميل.
5.  **تخزين التوكن:** يقوم العميل (المتصفح أو تطبيق الجوال) بتخزين التوكن بشكل آمن.
6.  **الطلبات اللاحقة:** في كل طلب إلى مسار محمي، يرسل العميل التوكن في ترويسة HTTP `Authorization`.
    ```
    Authorization: Bearer <the_jwt_token>
    ```
7.  **حماية المسار:** يقوم الخادم، باستخدام Middleware، بالتحقق من التوكن في كل طلب وارد. إذا كان التوكن صالحًا وموقعًا بشكل صحيح، يسمح للطلب بالمرور. وإلا، يرسل خطأ `401 Unauthorized`.

---
### ⚙️ 4. كيف يبدو هذا في Express؟ (بشكل مفاهيمي)
لتأمين نقاط النهاية في Express، نستخدم Middleware للمصادقة:
```javascript
// Middleware للتحقق من التوكن
const authMiddleware = (req, res, next) => {
  // 1. احصل على التوكن من ترويسة Authorization
  // 2. تحقق من صحة التوكن
  // 3. إذا كان صالحًا، استدعِ next()
  // 4. إذا لم يكن صالحًا، أرسل خطأ 401
};

// يمكن الآن حماية أي مسار عن طريق إضافة الـ Middleware قبله
app.get('/api/my-profile', authMiddleware, (req, res) => {
  // هذا الكود لن يعمل إلا إذا تم تمرير توكن صالح
  res.send('This is your private profile data.');
});
```

---