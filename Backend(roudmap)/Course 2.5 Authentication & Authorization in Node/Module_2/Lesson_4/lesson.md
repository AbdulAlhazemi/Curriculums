## 🔑 الوحدة 2: المصادقة القائمة على التوكن (Token-Based Authentication)

### 📘 الدرس 4: تخزين JWTs لدى العميل

#### 🧠 **ماذا ستتعلم**
* الطريقتان الأساسيتان لتخزين JWTs في المتصفح: `localStorage` و `cookies`.
* إيجابيات وسلبيات استخدام `localStorage`.
* إيجابيات وسلبيات استخدام الكوكيز، وخاصة كوكيز `HttpOnly`.
* الثغرات الأمنية المرتبطة بكل طريقة (XSS و CSRF).
* النهج الموصى به لأمان أفضل.

---
### 🤔 1. التحدي: أين نضع التوكن؟
في الدرس السابق، استلم العميل توكن JWT من الخادم بعد تسجيل الدخول بنجاح. السؤال الآن هو: أين يجب على العميل (المتصفح) تخزين هذا التوكن ليتمكن من إرساله مرة أخرى مع كل طلب لاحق؟

هناك خياران رئيسيان في بيئة المتصفح: `localStorage` وملفات تعريف الارتباط (Cookies).

---
### 🗄️ 2. الطريقة الأولى: التخزين المحلي (localStorage)
`localStorage` هو مخزن بسيط للبيانات بصيغة مفتاح-قيمة متاح في جميع المتصفحات الحديثة.

* **كيف يعمل:**
    1.  بعد تسجيل الدخول، يقوم كود جافاسكريبت بحفظ التوكن: `localStorage.setItem('accessToken', token);`
    2.  قبل إرسال أي طلب إلى مسار محمي، يقوم كود جافاسكريبت بقراءة التوكن من `localStorage` وإضافته يدويًا إلى ترويسة `Authorization`.

* **الإيجابيات ✅:**
    * سهل جدًا في التنفيذ والاستخدام.
    * يعمل بشكل جيد مع أطر عمل جافاسكريبت الحديثة (React, Vue, Angular).

* **السلبيات ❌ (الخطر الأمني):**
    * **عرضة لهجمات XSS (Cross-Site Scripting):** هذا هو العيب الأكبر. إذا تمكن مهاجم من حقن كود جافاسكريبت خبيث في موقعك، فيمكن لهذا الكود قراءة **كل شيء** في `localStorage`، بما في ذلك توكن المستخدم. إذا تمت سرقة التوكن، يمكن للمهاجم انتحال شخصية المستخدم بالكامل.

---
### 🍪 3. الطريقة الثانية: ملفات تعريف الارتباط (Cookies)
يمكن للخادم أن يطلب من المتصفح تخزين التوكن في كوكي.

* **كيف يعمل:**
    1.  يرسل الخادم استجابة تحتوي على ترويسة `Set-Cookie` مع التوكن.
    2.  يقوم المتصفح بتخزين الكوكي.
    3.  الأهم من ذلك، يقوم المتصفح **تلقائيًا** بإرفاق هذا الكوكي مع كل طلب مستقبلي يتم إرساله إلى نفس النطاق.

* **التحسين الأمني: كوكيز `HttpOnly`**
    هذه هي الميزة الحاسمة. عند إعداد الكوكي، يمكن للخادم إضافة علامة `HttpOnly`.
    `Set-Cookie: accessToken=...; HttpOnly; Secure; SameSite=Strict`
    * **ماذا تفعل `HttpOnly`؟** هي تمنع كود جافاسكريبت الذي يعمل في المتصفح من الوصول إلى هذا الكوكي أو قراءته. يمكن للمتصفح إرساله واستقباله فقط.
    * **الفائدة:** هذا **يحمي التوكن تمامًا من السرقة عبر هجمات XSS**، لأن الكود الخبيث لا يمكنه رؤيته.

* **السلبيات ❌ (الخطر الأمني):**
    * **عرضة لهجمات CSRF (Cross-Site Request Forgery):** يحدث هذا الهجوم عندما يقوم موقع خبيث بخداع المستخدم المسجل دخوله لإرسال طلب غير مقصود إلى تطبيقك. بما أن المتصفح يرسل الكوكيز تلقائيًا، فسيتم إرسال كوكي المصادقة مع هذا الطلب الخبيث. يمكن التخفيف من هذه الهجمات باستخدام تقنيات مثل `SameSite` cookies أو CSRF tokens.

---
### ⚖️ 4. مقارنة وتوصية

| الخاصية | `localStorage` | كوكي `HttpOnly` |
| :--- | :--- | :--- |
| **سهولة الاستخدام** | سهل جدًا من جانب العميل. | يتطلب إعدادًا من جانب الخادم. |
| **عرضة لـ XSS** | **عالية جدًا.** | **منخفضة جدًا / لا يوجد.** |
| **عرضة لـ CSRF** | منخفضة (لا يتم إرساله تلقائيًا).| **عالية** (إلا إذا تم تأمينه بـ `SameSite`). |
| **الإرسال التلقائي** | لا (يتطلب جافاسكريبت). | نعم (يتم إرساله تلقائيًا بواسطة المتصفح). |

**التوصية:**
لأمان أفضل ضد سرقة التوكن، يعتبر تخزين التوكن في **كوكي `HttpOnly` مع تعيين `SameSite=Strict`** هو النهج الأكثر أمانًا لتطبيقات الويب التقليدية. إنه يوفر حماية قوية ضد XSS، ومعيار `SameSite` يوفر حماية جيدة ضد CSRF.

---

