## 🔑 الوحدة 2: المصادقة القائمة على التوكن (Token-Based Authentication)

### 📘 الدرس 5: توكنات التحديث (Refresh Tokens)

#### 🧠 **ماذا ستتعلم**
* المعضلة بين توكنات الوصول قصيرة العمر وطويلة العمر.
* ما هو توكن التحديث (Refresh Token) وما هو الغرض منه.
* دورة العمل الكاملة للمصادقة باستخدام توكن الوصول وتوكن التحديث معًا.
* الاعتبارات الأمنية لتخزين توكنات التحديث.

---
### 🤔 1. المعضلة: الأمان مقابل تجربة المستخدم
عند استخدام توكن JWT، نواجه سؤالاً صعبًا: ما هي مدة الصلاحية المناسبة للتوكن؟

* **توكن قصير العمر (مثل 15 دقيقة):**
    * **الميزة:** آمن جدًا. إذا تمت سرقته، فإن صلاحيته تنتهي بسرعة، مما يحد من الضرر.
    * **العيب:** تجربة مستخدم سيئة. سيضطر المستخدم إلى إعادة تسجيل الدخول كل 15 دقيقة.

* **توكن طويل العمر (مثل 30 يومًا):**
    * **الميزة:** تجربة مستخدم ممتازة. يبقى المستخدم مسجلاً دخوله لفترة طويلة.
    * **العيب:** غير آمن. إذا تمت سرقته، فسيتمكن المهاجم من الوصول إلى الحساب لفترة طويلة.

---
### 💡 2. الحل: نمط توكن التحديث
الحل لهذه المعضلة هو استخدام **نوعين** من التوكنات:

1.  **توكن الوصول (Access Token):**
    * هو توكن JWT **قصير العمر** (مثلاً، 15 دقيقة).
    * يتم إرساله مع كل طلب للوصول إلى الموارد المحمية.
    * يحتوي على بيانات المستخدم (Payload).

2.  **توكن التحديث (Refresh Token):**
    * هو توكن **طويل العمر** (مثلاً، 7 أيام أو 30 يومًا).
    * وظيفته **الوحيدة** هي الحصول على توكن وصول جديد عندما ينتهي القديم.
    * يتم إرساله **فقط** إلى نقطة نهاية خاصة (مثل `/refresh_token`).

> **ببساطة:**
> * **توكن الوصول** يشبه **تذكرة دخول يومية** لمدينة ملاهي. تستخدمها عند كل لعبة، وصلاحيتها قصيرة.
> * **توكن التحديث** يشبه **قسيمة الاشتراك السنوي**. لا تظهرها عند كل لعبة، بل تذهب بها مرة واحدة فقط إلى شباك التذاكر الرئيسي للحصول على تذكرة يومية جديدة. هي أكثر قيمة وتحتفظ بها في مكان آمن.

---
### ⚙️ 3. دورة العمل الكاملة
1.  **تسجيل الدخول:** يقوم المستخدم بتسجيل الدخول. يرد الخادم بـ **توكن وصول** (صالح لـ 15 دقيقة) و **توكن تحديث** (صالح لـ 7 أيام).
2.  **الوصول إلى الموارد:** يقوم العميل بتخزين كلا التوكنين. عند طلب مورد محمي (مثل `/api/profile`)، يرسل **توكن الوصول فقط**.
3.  **انتهاء صلاحية توكن الوصول:** بعد 15 دقيقة، يحاول العميل الوصول إلى `/api/profile` مرة أخرى. الخادم يرى أن التوكن منتهي الصلاحية ويرفض الطلب (يرسل خطأ `401 Unauthorized`).
4.  **طلب توكن جديد:** عندما يستقبل العميل خطأ `401`، فإنه يفهم أن توكن الوصول قد انتهى. الآن، يقوم **تلقائيًا وفي الخلفية** بإرسال طلب إلى نقطة نهاية خاصة مثل `/refresh_token`، ويرفق معه **توكن التحديث** الخاص به.
5.  **الخادم يصدر توكن جديد:** يتحقق الخادم من صحة توكن التحديث. إذا كان صالحًا، فإنه يصدر **توكن وصول جديد** (صالح لـ 15 دقيقة أخرى) ويرسله إلى العميل.
6.  **إعادة محاولة الطلب الأصلي:** يقوم العميل بتخزين توكن الوصول الجديد، ثم يعيد إرسال الطلب الأصلي إلى `/api/profile` الذي فشل في المرة الأولى. هذه المرة، ينجح الطلب.

**النتيجة:** كل هذا يحدث بسلاسة في الخلفية دون أن يشعر المستخدم بأي انقطاع. يبدو للمستخدم أنه لا يزال مسجلاً دخوله.

---
### 🔐 4. أمان وتخزين توكن التحديث
بما أن توكن التحديث طويل العمر وقوي جدًا، يجب تخزينه بأكثر الطرق أمانًا الممكنة.

* **الممارسة الأفضل:** تخزين **توكن التحديث** في **كوكي `HttpOnly`**. هذا يمنع سرقته عبر هجمات XSS.
* يمكن بعد ذلك تخزين **توكن الوصول** قصير العمر في ذاكرة تطبيق جافاسكريبت (in-memory variable)، حيث أن خطر سرقته أقل تأثيرًا بسبب مدة صلاحيته القصيرة.

---
