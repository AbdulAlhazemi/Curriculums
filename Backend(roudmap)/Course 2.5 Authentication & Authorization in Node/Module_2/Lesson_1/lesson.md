## 🔑 الوحدة 2: المصادقة القائمة على التوكن (Token-Based Authentication)

### 📘 الدرس 1: المصادقة القائمة على التوكن و JWT

#### 🧠 **ماذا ستتعلم**
* ما هي المصادقة القائمة على التوكن وكيف تحقق انعدام الحالة (Statelessness).
* ما هو توكن الويب JSON (JSON Web Token - JWT).
* دورة العمل الأساسية للمصادقة باستخدام JWT.
* إيجابيات وسلبيات استخدام التوكن مقارنة بالجلسات.

---
### 🤔 1. لماذا نحتاج بديلاً للجلسات؟
في الدرس السابق، رأينا أن المصادقة القائمة على الجلسات تتطلب من الخادم تخزين معلومات كل مستخدم قام بتسجيل الدخول. هذا النهج "ذو الحالة" (Stateful) يواجه تحديات:
* **قابلية التوسع (Scalability):** إذا كان لديك ملايين المستخدمين وخوادم متعددة، يصبح الحفاظ على مزامنة مخزن الجلسات بين جميع الخوادم أمرًا معقدًا ومكلفًا.
* **التوافقية:** التعامل مع الكوكيز قد يكون صعبًا مع العملاء غير المتصفحات، مثل تطبيقات الجوال الأصلية أو عند التعامل مع واجهات API من خوادم أخرى (مشاكل CORS).

الحل هو نهج **عديم الحالة (Stateless)**، وهذا ما توفره المصادقة القائمة على التوكن.

---
### 🎟️ 2. ما هي المصادقة القائمة على التوكن؟
هي آلية مصادقة لا يقوم فيها الخادم بتخزين أي معلومات عن جلسة المستخدم. بدلاً من ذلك، بعد تسجيل الدخول بنجاح، يصدر الخادم **"توكن" (Token)** للعميل. التوكن هو عبارة عن سلسلة نصية تحتوي على جميع المعلومات اللازمة للتحقق من هوية المستخدم وصلاحياته.

يقوم العميل بتخزين هذا التوكن وإرساله مع **كل طلب** لاحق إلى الخادم. يقوم الخادم بالتحقق من صحة التوكن في كل مرة دون الحاجة إلى الرجوع إلى أي مخزن جلسات.

> **ببساطة:** إذا كانت الجلسة تشبه **سوار معصم** في مدينة ملاهي (حيث تحتفظ الإدارة بسجل لك)، فإن التوكن يشبه **بطاقة VIP** تحتوي على اسمك وصورتك وتاريخ الصلاحية مطبوعة عليها. أي حارس أمن (أي خادم) يمكنه التحقق من البطاقة مباشرة دون الحاجة للاتصال بالمكتب الرئيسي.

---
### ✨ 3. المعيار الأشهر: JWT (JSON Web Tokens)
JWT هو معيار مفتوح (`RFC 7519`) يحدد طريقة مدمجة وآمنة لتمثيل المعلومات بين طرفين ككائن JSON. هذه المعلومات موثوقة لأنه يمكن التحقق منها رقميًا، حيث يتم توقيعها من قبل الخادم باستخدام مفتاح سري.

إنه المعيار الأكثر شيوعًا لإنشاء التوكن في واجهات API الحديثة.

---
### ⚙️ 4. دورة عمل المصادقة باستخدام JWT
1.  **تسجيل الدخول:** يرسل العميل اسم المستخدم وكلمة المرور إلى `/login`.
2.  **التحقق:** يتحقق الخادم من صحة بيانات الاعتماد.
3.  **إنشاء وتوقيع التوكن:** إذا كانت البيانات صحيحة، ينشئ الخادم توكن JWT يحتوي على بيانات المستخدم (مثل `userId`) ويوقعه بمفتاح سري.
4.  **إرسال التوكن للعميل:** يرسل الخادم التوكن مرة أخرى إلى العميل كجزء من استجابة JSON.
5.  **تخزين التوكن لدى العميل:** يقوم العميل (المتصفح أو تطبيق الجوال) بتخزين التوكن بشكل آمن (عادة في `localStorage`).
6.  **إرسال التوكن مع الطلبات:** في كل طلب لاحق إلى مسار محمي، يرفق العميل التوكن في ترويسة `Authorization` باستخدام صيغة `Bearer`.
    `Authorization: Bearer <token>`
7.  **الخادم يتحقق من التوكن:** يقوم Middleware على الخادم بالتحقق من وجود وصحة التوكن وتوقيعه. إذا كان كل شيء سليمًا، يسمح للطلب بالمرور.

---
### ⚖️ 5. مقارنة: الجلسات مقابل التوكن

| الخاصية | المصادقة بالجلسات | المصادقة بالتوكن (JWT) |
| :--- | :--- | :--- |
| **الحالة (State)** | ذات حالة (Stateful) | عديمة الحالة (Stateless) |
| **التخزين** | الخادم يخزن بيانات الجلسة. | العميل يخزن التوكن. |
| **قابلية التوسع** | أصعب في التوسع الأفقي. | سهلة التوسع (لا يوجد حالة مشتركة). |
| **التوافقية** | قد تكون صعبة مع الجوال و CORS. | تعمل بشكل ممتاز في كل البيئات. |
| **البيانات في المعرّف**| الكوكي يحتوي فقط على ID عشوائي. | التوكن يمكن أن يحتوي على بيانات إضافية (Payload).|

---