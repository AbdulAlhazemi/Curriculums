## 🔑 الوحدة 3: مواضيع متقدمة في الأمان

### 📘 الدرس 3: أشهر المخاطر الأمنية في المصادقة والتخويل

#### 🧠 **ماذا ستتعلم**
* خطر سياسات كلمات المرور الضعيفة.
* ثغرة مراجع الكائنات المباشرة غير الآمنة (IDOR).
* أهمية تحديد معدل محاولات تسجيل الدخول.
* مخاطر تسريب المعلومات عبر رسائل الخطأ.

---
### 🚨 1. مقدمة: أخطاء شائعة ذات عواقب وخيمة
بناء نظام آمن لا يقتصر فقط على تطبيق التقنيات الصحيحة (مثل bcrypt و JWT)، بل يتعلق أيضًا بتجنب الأخطاء الشائعة التي يمكن أن تترك ثغرات خطيرة في تطبيقك. هذا الدرس هو بمثابة قائمة تدقيق لأهم الأشياء التي يجب الانتباه إليها.

---
### 📜 2. سياسات كلمات المرور الضعيفة
* **المشكلة:** السماح للمستخدمين باختيار كلمات مرور بسيطة وسهلة التخمين مثل `"123456"` أو `"password"`. حتى لو قمت بتجزئتها، يمكن للمهاجمين كسرها بسهولة باستخدام قوائم كلمات المرور الشائعة.
* **الحل:** فرض **سياسة كلمات مرور قوية** من جانب الخادم عند التسجيل. يجب أن تطلب:
    * حدًا أدنى للطول (مثل 8 أحرف).
    * مزيجًا من الأحرف الكبيرة والصغيرة والأرقام والرموز.
    * يمكنك استخدام مكتبات مثل `zxcvbn` لتقدير قوة كلمة المرور ومنع الكلمات الضعيفة جدًا.

---
### 🆔 3. مراجع الكائنات المباشرة غير الآمنة (IDOR)
هذه واحدة من أخطر ثغرات **التخويل**. تحدث عندما يستخدم التطبيق معرفًا (ID) يرسله المستخدم للوصول إلى كائن في قاعدة البيانات مباشرة، **دون التحقق مما إذا كان هذا المستخدم يمتلك الإذن للوصول إلى هذا الكائن المحدد**.

* **مثال على الثغرة:**
    1.  المستخدم "علي" (الذي يملك `id = 10`) يسجل دخوله.
    2.  يطلب عرض فاتورته عن طريق الذهاب إلى `GET /api/invoices/55`. الخادم يتحقق من أن علي مسجل دخوله ويعرض له الفاتورة رقم 55 (التي تخصه).
    3.  يقوم علي بتغيير الرقم في عنوان URL يدويًا إلى `GET /api/invoices/56`.
    4.  **إذا عرض الخادم الفاتورة رقم 56 (التي تخص مستخدمًا آخر)، فهذه ثغرة IDOR!**

* **الحل:** يجب دائمًا التحقق من الملكية. الاستعلام الصحيح في قاعدة البيانات يجب أن يكون:
    ```sql
    -- لا تجلب الفاتورة فقط بمعرفها، بل بمعرفها ومعرف المستخدم الحالي
    SELECT * FROM invoices WHERE id = 56 AND owner_user_id = 10;
    ```
    إذا لم يتم العثور على نتيجة، فهذا يعني أن المستخدم لا يملك هذا المورد، ويجب إرجاع خطأ `403 Forbidden` أو `404 Not Found`.

---
### ⏳ 4. عدم تحديد معدل محاولات تسجيل الدخول
* **المشكلة:** عدم وضع حد لعدد محاولات تسجيل الدخول الفاشلة من عنوان IP معين.
* **الخطر:** يسمح هذا للمهاجمين بشن **هجوم القوة الغاشمة (Brute-force Attack)**، حيث يقومون بتجربة آلاف كلمات المرور الشائعة في الثانية حتى ينجحوا في اختراق حساب.
* **الحل:** قم بتطبيق **تحديد المعدل (Rate Limiting)** على نقطة نهاية تسجيل الدخول. بعد عدد معين من المحاولات الفاشلة (مثل 5 محاولات في 15 دقيقة)، قم بحظر أي محاولات أخرى من عنوان IP هذا بشكل مؤقت. يمكن تحقيق ذلك بسهولة باستخدام Middleware مثل `express-rate-limit`.

---
### 💬 5. تسريب المعلومات في رسائل الخطأ
* **المشكلة:** تقديم رسائل خطأ مفصلة جدًا للمستخدم النهائي.
* **مثال سيئ:**
    * إذا أدخل المستخدم اسمًا خاطئًا: "اسم المستخدم غير موجود".
    * إذا أدخل كلمة مرور خاطئة: "كلمة المرور غير صحيحة".
    * هذا السلوك يسمح للمهاجم بتخمين أسماء المستخدمين الصالحة في نظامك.
* **الحل:** استخدم رسائل خطأ عامة وغامضة لعمليات المصادقة.
    * **مثال جيد:** **"اسم المستخدم أو كلمة المرور غير صحيحة"** في كلتا الحالتين. هذا لا يعطي المهاجم أي معلومات إضافية.

---
