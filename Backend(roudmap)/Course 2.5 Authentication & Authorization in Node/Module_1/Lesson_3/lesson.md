## 🔑 الوحدة 1: أساسيات المصادقة والتخويل

### 📘 الدرس 3: المصادقة القائمة على الجلسات (Session-Based Authentication)

#### 🧠 **ماذا ستتعلم**
* ما هي المصادقة القائمة على الجلسات وكيف تحل مشكلة انعدام الحالة في HTTP.
* دور ملفات تعريف الارتباط (Cookies) في الحفاظ على الجلسة.
* كيف يقوم الخادم بتخزين بيانات الجلسة.
* دورة العمل الكاملة لتسجيل الدخول باستخدام الجلسات.
* إيجابيات وسلبيات هذا النهج.

---
### 🤔 1. مشكلة بروتوكول HTTP: انعدام الحالة
كما تعلمنا، بروتوكول HTTP هو بروتوكول **عديم الحالة (Stateless)**. هذا يعني أن كل طلب يعتبر مستقلاً تمامًا، والخادم لا يتذكر أي شيء عن الطلبات السابقة من نفس العميل.

**التحدي:** إذا قام مستخدم بتسجيل الدخول، كيف سيتذكره الخادم في الطلب التالي عند انتقاله إلى صفحة أخرى؟ نحتاج إلى آلية للحفاظ على "حالة" تسجيل دخول المستخدم عبر عدة طلبات.

---
### 💡 2. الحل: الجلسات وملفات تعريف الارتباط (Cookies)
المصادقة القائمة على الجلسات هي طريقة **ذات حالة (Stateful)** لحل هذه المشكلة. الفكرة الأساسية هي:
1.  عندما يقوم المستخدم بتسجيل الدخول بنجاح، يقوم **الخادم بإنشاء "جلسة" (Session)** فريدة له ويخزنها في جانبه (في الذاكرة أو قاعدة البيانات).
2.  يرسل الخادم معرفًا فريدًا لهذه الجلسة (Session ID) إلى **العميل (المتصفح)**.
3.  يقوم المتصفح بتخزين هذا المعرف في **ملف تعريف ارتباط (Cookie)**.
4.  في كل طلب لاحق، يقوم المتصفح تلقائيًا بإرسال هذا الكوكي مرة أخرى إلى الخادم.
5.  يستخدم الخادم الـ Session ID من الكوكي للعثور على بيانات الجلسة المقابلة، وبذلك يتعرف على المستخدم.

> **ببساطة:** تخيل أنك في مدينة ملاهي. عند الدخول (تسجيل الدخول)، تحصل على **سوار معصم** (الكوكي الذي يحتوي على Session ID). لكل لعبة تريد ركوبها (كل طلب جديد)، ما عليك سوى إظهار السوار بدلاً من شراء تذكرة جديدة في كل مرة. إدارة مدينة الملاهي (الخادم) لديها سجل مرتبط برقم سوارك.

---
### ⚙️ 3. دورة العمل خطوة بخطوة
1.  **طلب تسجيل الدخول:** يرسل المستخدم اسم المستخدم وكلمة المرور إلى الخادم.
2.  **التحقق وإنشاء الجلسة:** الخادم يتحقق من صحة البيانات. إذا كانت صحيحة، فإنه ينشئ Session ID فريدًا (مثل `abc123xyz`) ويخزن بيانات المستخدم المرتبطة به في مخزن الجلسات الخاص به (e.g., `{ userId: 42, role: 'admin' }`).
3.  **الخادم يرسل الكوكي:** يرد الخادم على العميل، وتتضمن استجابته ترويسة `Set-Cookie` تحتوي على الـ Session ID.
4.  **المتصفح يخزن الكوكي:** يقوم المتصفح تلقائيًا بتخزين هذا الكوكي المرتبط بنطاق الموقع.
5.  **الطلبات اللاحقة:** لكل طلب مستقبلي لنفس الموقع، يقوم المتصفح بإرفاق الكوكي تلقائيًا في ترويسة `Cookie`.
6.  **الخادم يتحقق من الجلسة:** عند استقبال الطلب، يقرأ الخادم الـ Session ID من الكوكي، ويبحث عنه في مخزن الجلسات الخاص به، ويسترجع بيانات المستخدم. الآن يعرف الخادم من هو المستخدم ويمكنه تخويل طلبه.

---
### ⚖️ 4. إيجابيات وسلبيات المصادقة بالجلسات

| الإيجابيات ✅ | السلبيات ❌ |
| :--- | :--- |
| **مفهوم بسيط ومستخدم منذ فترة طويلة.** | **الخادم ذو حالة (Stateful):** هذا يتعارض مع مبدأ REST الخاص بانعدام الحالة. |
| **البيانات الحساسة تبقى على الخادم:** لا يتم تخزين سوى معرف الجلسة العشوائي لدى العميل. | **مشاكل قابلية التوسع (Scalability):** إذا كان لديك عدة خوادم، فيجب أن تشترك جميعها في نفس مخزن الجلسات، مما يضيف تعقيدًا. |
| **سهولة تسجيل الخروج:** يمكن للخادم إنهاء الجلسة بسهولة عن طريق حذفها من مخزنه. | **مشاكل مع CORS وتطبيقات الجوال:** قد يكون التعامل مع الكوكيز صعبًا عبر النطاقات المختلفة أو مع تطبيقات الجوال الأصلية. |

---

