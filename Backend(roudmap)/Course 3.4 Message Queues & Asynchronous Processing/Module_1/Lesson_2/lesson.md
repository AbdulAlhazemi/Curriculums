## 📬 الوحدة 1: أساسيات طوابير الرسائل

### 📘 الدرس 2: حالات استخدام طوابير الرسائل

#### 🧠 **ماذا ستتعلم**
* كيفية استخدام طوابير الرسائل لتفريغ المهام طويلة الأمد إلى عمال الخلفية.
* كيف تسهل طوابير الرسائل التواصل بين الخدمات المصغرة (Microservices).
* كيفية استخدام الطوابير لتحديد معدل الطلبات وتخفيف الضغط.
* دور الطوابير في التعامل مع الأخطاء وإعادة المحاولة بشكل موثوق.

---
### 🤔 1. متى أستخدم طابور الرسائل؟
القاعدة العامة هي: استخدم طابور الرسائل كلما كان لديك مهمة يمكن تنفيذها **لاحقًا (بشكل غير متزامن)**، خاصة إذا كانت هذه المهمة:
* بطيئة أو تستهلك موارد كثيرة.
* تتطلب التواصل مع خدمة أخرى قد تكون غير متاحة مؤقتًا.
* تحتاج إلى ضمان تنفيذها بشكل موثوق حتى لو حدث فشل مؤقت.

---
### 🏃 2. المهام غير المتزامنة (أعمال الخلفية)
هذا هو الاستخدام الأكثر شيوعًا.
* **المشكلة:** يقوم مستخدم برفع فيديو عالي الجودة. يحتاج خادمك إلى معالجته وتحويله إلى عدة جودات مختلفة (1080p, 720p, 480p). هذه عملية بطيئة جدًا وتستهلك الكثير من موارد المعالج. لا يجب أن ينتظر المستخدم في شاشة التحميل حتى تنتهي هذه العملية.
* **الحل باستخدام الطابور:**
    1.  يستقبل خادم الويب الفيديو ويحفظه.
    2.  يضع رسالة في طابور `video-processing` تحتوي على معرف الفيديو.
    3.  يرسل **فورًا** استجابة للمستخدم: "تم استلام الفيديو بنجاح، وسيكون جاهزًا للمشاهدة قريبًا".
    4.  في الخلفية، هناك "عامل" (Worker service) منفصل يستهلك الرسائل من الطابور ويقوم بعملية التحويل البطيئة.

---
### 🤝 3. التواصل بين الخدمات المصغرة (Microservices)
* **المشكلة:** في معمارية الخدمات المصغرة، لديك خدمات مستقلة (خدمة الطلبات، خدمة الإشعارات، خدمة المخزون). إذا قامت خدمة الطلبات باستدعاء خدمة الإشعارات مباشرة عبر HTTP، وفشلت خدمة الإشعارات، فقد يفشل الطلب بأكمله. هذا يخلق ترابطًا وثيقًا وهشاشة في النظام.
* **الحل باستخدام الطابور:**
    1.  عند إنشاء طلب جديد، تقوم `OrderService` بوضع رسالة `order_created` في طابور.
    2.  كل من `NotificationService` و `InventoryService` "تستمعان" إلى هذا الطابور.
    3.  عند وصول الرسالة، تقوم خدمة الإشعارات باستهلاكها وإرسال بريد إلكتروني، وتقوم خدمة المخزون باستهلاكها وخصم المنتج من المخزون.
* **الفائدة:** الخدمات أصبحت **منفصلة (decoupled)**. خدمة الطلبات لا تحتاج حتى إلى معرفة ما إذا كانت الخدمات الأخرى تعمل أم لا.

---
### 🚦 4. تحديد المعدل وتخفيف الضغط (Rate Limiting & Throttling)
* **المشكلة:** تطبيقك يعتمد على واجهة API خارجية تسمح لك فقط بـ 10 طلبات في الثانية. إذا حصلت على دفعة مفاجئة من 100 مستخدم في نفس الثانية، فستفشل معظم الطلبات إلى الـ API الخارجي.
* **الحل باستخدام الطابور:** بدلاً من إجراء المكالمات مباشرة، يقوم خادم الويب الخاص بك بوضع 100 "مهمة" في طابور. لديك عامل واحد فقط يستهلك من هذا الطابور **بمعدل متحكم به** (على سبيل المثال، يسحب رسالة واحدة كل 100 ميلي ثانية)، مما يضمن أنك لا تتجاوز أبدًا حد الـ 10 طلبات في الثانية.

---
### 🔄 5. جدولة المهام وإعادة المحاولة
* **المشكلة:** فشلت مهمة ما بسبب مشكلة مؤقتة (مثل انقطاع الشبكة). لا تريد أن تفقد هذه المهمة.
* **الحل باستخدام الطابور:** توفر أنظمة طوابير الرسائل الموثوقية. عندما يسحب المستهلك رسالة، لا يتم حذفها على الفور. يجب على المستهلك أن يرسل **إقرارًا (Acknowledgement أو `ack`)** إلى الطابور بعد أن ينجح في معالجة الرسالة.
* **منطق إعادة المحاولة:** إذا فشل المستهلك في معالجة الرسالة (ولم يرسل `ack`)، يمكن إعداد الطابور لإعادة الرسالة إلى الطابور ليتم محاولتها مرة أخرى لاحقًا، أو نقلها إلى "طابور الرسائل الميتة" (Dead-Letter Queue) لمراجعتها يدويًا.

---
