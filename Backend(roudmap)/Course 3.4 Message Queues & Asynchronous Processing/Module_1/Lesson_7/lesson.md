## 📬 الوحدة 1: أساسيات طوابير الرسائل

### 📘 الدرس 7: مقدمة في طوابير المهام (Task Queues)

#### 🧠 **ماذا ستتعلم**
* ما هي مكتبة طابور المهام (Task Queue Library).
* كيف تبني هذه المكتبات فوق أنظمة طوابير الرسائل الأساسية.
* الميزات المتقدمة التي توفرها مكتبات مثل BullMQ (المهام المؤجلة، إعادة المحاولة، إلخ).
* المكونات الأساسية لنظام طابور المهام: الطابور، العامل، والمهمة.

---
### 🤔 1. ما وراء `amqplib`: الحاجة إلى مكتبة متخصصة
استخدام مكتبة مثل `amqplib` يمنحك تحكمًا كاملاً في بروتوكول AMQP، ولكنه يعني أيضًا أنك مسؤول عن بناء العديد من الميزات الشائعة بنفسك، مثل:
* منطق معقد لإعادة محاولة المهام الفاشلة.
* جدولة مهمة ليتم تنفيذها في المستقبل.
* مراقبة تقدم المهام، وحالات الفشل، والاكتمال.
* ضمان استمرارية المهام في حالة إعادة تشغيل وسيط الرسائل.

**الحل:** مكتبة **طابور مهام**. هي طبقة تجريدية (abstraction layer) عالية المستوى تُبنى فوق وسيط رسائل (عادةً Redis أو RabbitMQ) وهي مصممة خصيصًا لإدارة المهام في الخلفية (background jobs).

---
### 🐂 2. الأداة: BullMQ
**BullMQ** هي مكتبة طوابير مهام حديثة، قوية، وعالية الأداء لبيئة Node.js.
* **التكنولوجيا الأساسية:** هي مبنية فوق **Redis**. هذا يجعلها سريعة للغاية ويسمح لها بالاستفادة من هياكل بيانات Redis القوية.

> **ببساطة:** إذا كانت `amqplib` هي مجموعة من **قطع المحرك الخام** التي تمنحك تحكمًا كاملاً، فإن `BullMQ` هي **محرك كامل ومجمع مسبقًا مع لوحة تحكم**. هي تمنحك كل القوة ولكن مع أدوات تحكم أبسط وميزات مدمجة أكثر بكثير.

---
### ⚙️ 3. مفاهيم BullMQ الأساسية
المصطلحات متشابهة ولكنها أكثر تركيزًا على "المهام".
* **Queue (الطابور):** الكائن الرئيسي الذي يمثل نوعًا معينًا من المهام (مثل `emailQueue`).
* **Job (المهمة):** وحدة عمل واحدة يتم وضعها في الطابور. تحتوي على البيانات اللازمة لأداء المهمة. (هذه هي "الرسالة").
* **Worker (العامل):** العملية التي تستمع إلى الطابور، تسحب المهام، وتنفذ منطق المعالجة. (هذا هو "المستهلك").

**مثال على دورة العمل (مفاهيميًا):**
```javascript
// في خادم الويب (المنتج)
const myQueue = new Queue('email-queue');
await myQueue.add('sendWelcomeEmail', { to: 'user@example.com', name: 'Ahmed' });

// في خدمة منفصلة (المستهلك)
const myWorker = new Worker('email-queue', async (job) => {
  // job.data يحتوي على { to: '...', name: '...' }
  console.log(`Sending email to ${job.data.to}`);
  // ... منطق إرسال البريد الإلكتروني ...
});
```
لاحظ كيف أن الواجهة البرمجية (API) أبسط وأكثر وضوحًا.

---
### ⭐ 4. ميزات متقدمة توفرها طوابير المهام
هذه هي الأسباب الحقيقية لاستخدام مكتبة مثل BullMQ:

* **المهام المؤجلة (Delayed Jobs):** يمكنك بسهولة جدولة مهمة لتعمل بعد فترة تأخير معينة.
    ```javascript
    myQueue.add('jobName', data, { delay: 10000 }); // نفذ بعد 10 ثوانٍ
    ```
* **إعادة محاولة المهام (Job Retries):** إعادة محاولة مهمة فاشلة تلقائيًا لعدد معين من المرات، مع إمكانية زيادة فترة الانتظار بين كل محاولة (exponential backoff).
    ```javascript
    new Worker(..., { attempts: 5, backoff: 2000 });
    ```
* **تحديد المعدل (Rate Limiting):** يمكنك تحديد عدد المهام التي يمكن معالجتها في فترة زمنية معينة، وهو أمر رائع للتعامل مع واجهات API خارجية لها حدود.
* **طوابير الأولوية (Priority Queues):** يمكنك إعطاء بعض المهام أولوية أعلى (مثل إرسال بريد إلكتروني لإعادة تعيين كلمة المرور) ليتم معالجتها قبل المهام ذات الأولوية المنخفضة (مثل إرسال نشرة إخبارية).
* **واجهة مراقبة (Monitoring UI):** توفر معظم هذه المكتبات لوحات تحكم رسومية (مثل `bull-board`) تتيح لك مراقبة حالة الطوابير، رؤية المهام الفاشلة، وإعادة تشغيلها يدويًا.

---
