## 🧪 الوحدة 2: اختبارات التكامل و E2E

### 📘 الدرس 1: الاختبارات التكاملية (Integration Testing)

#### 🧠 **ماذا ستتعلم**
* ما هو الاختبار التكاملي وما الغرض منه.
* الفرق الجوهري بين اختبارات الوحدة واختبارات التكامل.
* مثال شائع: اختبار تفاعل نقطة نهاية API مع قاعدة بيانات حقيقية.
* الإعدادات المطلوبة لإجراء اختبارات تكاملية (مثل قاعدة بيانات مخصصة للاختبار).

---
### 🤔 1. الصعود في هرم الاختبار
في الدروس السابقة، أتقنّا اختبارات الوحدة، التي تتحقق من كل مكون في عزلة تامة. ولكن، قد تنجح جميع اختبارات الوحدة، ورغم ذلك لا يعمل التطبيق!

**لماذا؟** لأن الأخطاء غالبًا ما تحدث عند **نقاط الاتصال** أو "التكامل" بين الوحدات. قد تعمل الدالة (أ) بشكل مثالي بمفردها، والدالة (ب) تعمل بشكل مثالي بمفردها، لكن الطريقة التي تستدعي بها الدالة (أ) الدالة (ب) قد تكون خاطئة.

**الهدف من الاختبار التكاملي:** التحقق من أن الوحدات أو الخدمات المختلفة تعمل معًا بشكل صحيح كمجموعة.

> **ببساطة:** لقد قمت باختبار وحدة لشمعة الاحتراق (Spark Plug) وتأكدت من أنها تعمل. وقمت باختبار وحدة لمضخة الوقود وتأكدت من أنها تعمل. الاختبار التكاملي هو بمثابة توصيل المضخة وشمعة الاحتراق بالمحرك، ومحاولة تشغيله للتأكد من أن **التوصيلات** بينها صحيحة وأن المحرك يعمل بالفعل.

---
### ⚖️ 2. الفرق الرئيسي: العزل مقابل التكامل

| الخاصية | اختبار الوحدة (Unit Test) | اختبار التكامل (Integration Test) |
| :--- | :--- | :--- |
| **النطاق** | وحدة واحدة (دالة، كلاس). | وحدتان أو أكثر تتفاعلان. |
| **الاعتماديات** | **يتم محاكاتها (Mocked).** لا نتحدث مع قاعدة بيانات حقيقية. | **حقيقية.** نستخدم غالبًا قاعدة بيانات حقيقية (لكن مخصصة للاختبار). |
| **السرعة** | سريع جدًا. | أبطأ نسبيًا. |
| **الهدف** | التحقق من صحة منطق الوحدة. | التحقق من صحة التفاعل بين الوحدات. |

---
### ⚙️ 3. مثال شائع: اختبار نقطة نهاية API
لنفترض أن لدينا نقطة نهاية `POST /api/users` في تطبيق Express. عندما يتم استدعاؤها، يحدث التدفق التالي:
1.  يستقبل الـ `router` الطلب ويوجهه إلى `userController`.
2.  يقوم الـ `userController` بالتحقق من المدخلات واستدعاء `userService`.
3.  يقوم الـ `userService` بتطبيق منطق العمل وإنشاء كائن المستخدم.
4.  يستدعي `userService` الـ `userRepository` لحفظ المستخدم في **قاعدة البيانات الفعلية**.
5.  يتم إرسال استجابة نجاح (e.g., `201 Created`).

**وظيفة الاختبار التكاملي هنا** هي اختبار هذا التدفق بأكمله. سيقوم الاختبار بإرسال طلب HTTP حقيقي إلى نقطة النهاية، ثم سيتحقق من قاعدة البيانات مباشرة ليرى ما إذا تم إنشاء المستخدم بنجاح. إنه يختبر تكامل الـ Router, Controller, Service, و Database معًا.

---
### 🔧 4. الإعداد للاختبارات التكاملية
الاختبارات التكاملية لها آثار جانبية (تُغير حالة قاعدة البيانات). لذلك، **لا يجب أبدًا تشغيلها على قاعدة بيانات الإنتاج أو حتى التطوير**.

**الحل:** استخدام **قاعدة بيانات مخصصة للاختبار فقط**.

**دورة العمل:**
1.  **إنشاء قاعدة بيانات اختبار:** أنشئ قاعدة بيانات منفصلة تمامًا (مثل `myapp_test`) تُستخدم فقط لتشغيل الاختبارات الآلية.
2.  **إعداد التطبيق:** يجب أن يعرف تطبيقك متى يتصل بقاعدة بيانات الاختبار (عادةً عن طريق متغير بيئة، مثل `NODE_ENV=test`).
3.  **إدارة الحالة:** قبل تشغيل كل اختبار (أو كل مجموعة اختبار)، يجب التأكد من أن قاعدة البيانات في حالة نظيفة ومعروفة. هذا يتضمن عادةً:
    * **إعادة تعيين الجداول:** حذف جميع الصفوف من الجداول ذات الصلة (باستخدام أمر مثل `TRUNCATE`).
    * **بذر البيانات (Seeding):** إدراج بعض البيانات الأولية المعروفة التي سيعتمد عليها الاختبار.
4.  **التنظيف:** بعد انتهاء الاختبار، من الجيد تنظيف البيانات التي تم إنشاؤها.

> **ملاحظة:** توفر أطر العمل مثل Jest "خطافات" (Hooks) مثل `beforeAll`, `afterAll`, `beforeEach`, `afterEach`، وهي مثالية لوضع منطق إعداد وتنظيف قاعدة البيانات هذا.

---
