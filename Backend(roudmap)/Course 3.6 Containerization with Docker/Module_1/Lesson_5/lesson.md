## 🐳 الوحدة 1: أساسيات Docker والحاويات

### 📘 الدرس 5: كتابة Dockerfile لتطبيقات Node.js

#### 🧠 **ماذا ستتعلم**
* الهيكل الأساسي لملف `Dockerfile`.
* أشهر تعليمات `Dockerfile` (`FROM`, `WORKDIR`, `COPY`, `RUN`, `EXPOSE`, `CMD`).
* كيفية بناء `Dockerfile` لتغليف تطبيق Node.js.
* تقنيات لتحسين وقت البناء وحجم الصورة.

---
### 📜 1. ملف Dockerfile: الوصفة
كما تعلمنا، `Dockerfile` هو ملف نصي يحتوي على التعليمات اللازمة لبناء صورة Docker. كل تعليمة في الملف تمثل **طبقة (layer)** في الصورة النهائية. بناء الصورة هو عملية تنفيذ هذه التعليمات بالترتيب.

**هدفنا:** كتابة `Dockerfile` يقوم بتغليف تطبيق Express بسيط ليصبح جاهزًا للتشغيل في أي مكان.

---
### ✍️ 2. بناء Dockerfile أساسي خطوة بخطوة
لنفترض أن لدينا تطبيق Express بسيط. سنقوم ببناء `Dockerfile` له.

**`Dockerfile`**
```dockerfile
# ----------------------------------------------------
# الخطوة 1: اختيار الصورة الأساسية
# نبدأ من صورة رسمية تحتوي على Node.js إصدار 20 وبيئة Alpine Linux الخفيفة.
FROM node:20-alpine

# ----------------------------------------------------
# الخطوة 2: تحديد مجلد العمل داخل الحاوية
# جميع الأوامر التالية ستنفذ داخل هذا المسار.
WORKDIR /app

# ----------------------------------------------------
# الخطوة 3: نسخ ملفات التبعيات
# ننسخ package.json و package-lock.json أولاً للاستفادة من التخزين المؤقت لـ Docker
COPY package*.json ./

# ----------------------------------------------------
# الخطوة 4: تثبيت التبعيات
# نستخدم npm ci لتثبيت التبعيات بالضبط كما هي في lockfile
RUN npm ci --only=production

# ----------------------------------------------------
# الخطوة 5: نسخ باقي كود التطبيق
# ننسخ كل شيء آخر من المجلد الحالي إلى مجلد العمل داخل الحاوية
COPY . .

# ----------------------------------------------------
# الخطوة 6: تحديد المنفذ
# هذا السطر للتوثيق فقط، يخبر Docker أن التطبيق داخل الحاوية سيستمع على هذا المنفذ
EXPOSE 3000

# ----------------------------------------------------
# الخطوة 7: تحديد أمر التشغيل
# هذا هو الأمر الذي سيتم تنفيذه عند بدء تشغيل حاوية من هذه الصورة
CMD [ "node", "index.js" ]
```

---
### 🚀 3. تحسين الـ Dockerfile

#### **أ. الاستفادة من التخزين المؤقت للبناء (Build Cache)**
يبني Docker الصور في طبقات. إذا لم يتغير شيء في طبقة ما أو في الطبقات التي تسبقها، سيقوم Docker بإعادة استخدام الطبقة من ذاكرة التخزين المؤقت بدلاً من إعادة بنائها.
لهذا السبب، قمنا بنسخ `package.json` وتثبيت التبعيات **قبل** نسخ باقي كود التطبيق. ملفات `package.json` لا تتغير كثيرًا، بينما كود التطبيق (`index.js`, etc.) يتغير باستمرار. هذا يعني أن طبقة `RUN npm ci` المكلفة زمنيًا سيتم تخزينها مؤقتًا وإعادة استخدامها في معظم عمليات البناء، مما يجعلها أسرع بكثير.

#### **ب. الحفاظ على صغر حجم الصور**
* **استخدم صور أساسية صغيرة:** صور `-alpine` (مثل `node:20-alpine`) أصغر بكثير من الصور القياسية.
* **استخدم ملف `.dockerignore`:** هذا الملف يعمل تمامًا مثل `.gitignore`. أنشئ ملفًا باسم `.dockerignore` في جذر مشروعك وأضف إليه أسماء الملفات والمجلدات التي لا تريد نسخها إلى صورتك. هذا يمنع تضمين الملفات غير الضرورية ويحافظ على صغر حجم الصورة.

**.dockerignore**
```
node_modules
npm-debug.log
.git
.gitignore
Dockerfile
```

---
