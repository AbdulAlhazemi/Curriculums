## 🐳 الوحدة 1: أساسيات Docker والحاويات

### 📘 الدرس 10: أفضل الممارسات لتطبيقات Node.js

#### 🧠 **ماذا ستتعلم**
* كيفية الحفاظ على صغر حجم صور Docker.
* كيفية تحسين أوقات البناء باستخدام التخزين المؤقت بفعالية.
* كيفية كتابة `Dockerfile` أكثر أمانًا.
* كيفية التعامل مع الإغلاق السلس (Graceful Shutdown) للتطبيقات.
* فائدة واستخدام البناء متعدد المراحل (Multi-stage Builds).

---
### 🎯 1. الهدف: صور أصغر، أسرع، وأكثر أمانًا
من السهل بناء صورة Docker "تعمل". لكن بناء صورة **جيدة** — صغيرة الحجم، سريعة البناء، وآمنة — يتطلب اتباع بعض أفضل الممارسات التي يستخدمها المحترفون.

---
### ✨ 2. أفضل الممارسات

#### **1. حافظ على صغر حجم الصور**
* **لماذا؟** الصور الأصغر يتم سحبها (pull) ودفعها (push) بشكل أسرع، مما يسرع من عمليات النشر. كما أنها تحتوي على مكونات أقل، مما يقلل من مساحة الهجوم الأمني.
* **كيف؟**
    * **استخدم صور أساسية صغيرة:** دائمًا فضل الصور التي تستخدم توزيعة `alpine` (مثل `node:20-alpine`) لأنها أصغر بكثير من الصور القياسية.
    * **استخدم ملف `.dockerignore`:** تمامًا مثل `.gitignore`، هذا الملف يخبر Docker بتجاهل ملفات ومجلدات معينة عند البناء (مثل `node_modules`, `.git`, `npm-debug.log`). هذا يمنع تسرب الملفات غير الضرورية والأسرار إلى صورتك.

#### **2. حسّن استخدام ذاكرة التخزين المؤقت للبناء**
* **لماذا؟** تسريع عمليات البناء المتكررة أثناء التطوير.
* **كيف؟** ترتيب التعليمات في `Dockerfile` مهم جدًا. ضع التعليمات التي تتغير بشكل نادر في الأعلى، وتلك التي تتغير باستمرار في الأسفل.
    ```dockerfile
    # تتغير نادرًا، سيتم تخزينها مؤقتًا
    FROM node:20-alpine
    WORKDIR /app
    COPY package*.json ./
    RUN npm ci --only=production

    # يتغير باستمرار، ضعه في النهاية
    COPY . .

    CMD [ "node", "index.js" ]
    ```

#### **3. استخدم البناء متعدد المراحل (Multi-stage Builds)**
* **لماذا؟** لفصل بيئة البناء عن بيئة الإنتاج، مما ينتج عنه صورة نهائية صغيرة جدًا وآمنة.
* **كيف؟** بيئة البناء قد تحتاج إلى `devDependencies` وأدوات أخرى. بيئة الإنتاج تحتاج فقط إلى الكود والـ `dependencies`. نستخدم `Dockerfile` واحد مع مرحلتين.
    ```dockerfile
    # --- المرحلة 1: البناء (Builder) ---
    FROM node:20-alpine AS builder
    WORKDIR /app
    COPY package*.json ./
    # تثبيت جميع التبعيات للبناء أو الاختبار
    RUN npm ci
    COPY . .
    # قد تقوم هنا بتشغيل اختبارات أو بناء واجهة أمامية
    # RUN npm test

    # --- المرحلة 2: الإنتاج (Production) ---
    FROM node:20-alpine
    WORKDIR /app
    # انسخ فقط التبعيات الإنتاجية من مرحلة البناء
    COPY --from=builder /app/node_modules ./node_modules
    COPY --from=builder /app/package*.json ./
    COPY --from=builder /app .
    
    EXPOSE 3000
    CMD [ "node", "index.js" ]
    ```
    الصورة النهائية تحتوي فقط على ما هو ضروري لتشغيل التطبيق.

#### **4. شغّل الحاوية كمستخدم غير جذري (Non-Root User)**
* **لماذا؟** للأمان. تشغيل الحاوية كمستخدم `root` (وهو الافتراضي) يمثل خطرًا أمنيًا. إذا تمكن مهاجم من اختراق تطبيقك، فسيكون لديه صلاحيات `root` داخل الحاوية.
* **كيف؟** أنشئ مستخدمًا جديدًا داخل `Dockerfile` وقم بالتبديل إليه.
    ```dockerfile
    # ... بعد نسخ الملفات
    RUN addgroup -S appgroup && adduser -S appuser -G appgroup
    USER appuser
    
    CMD [ "node", "index.js" ]
    ```

#### **5. تعامل مع الإغلاق السلس (Graceful Shutdowns)**
* **لماذا؟** عندما تقوم بتنفيذ `docker stop`، يرسل Docker إشارة `SIGTERM` إلى تطبيقك، مما يمنحه فرصة للإغلاق بشكل نظيف (مثل إغلاق اتصالات قاعدة البيانات). إذا لم يستجب تطبيقك، سيقوم Docker بقتله بالقوة بعد 10 ثوانٍ (`SIGKILL`).
* **كيف؟** في كود Node.js، استمع إلى إشارة `SIGTERM` وأغلق الخادم بشكل صحيح.
    ```javascript
    // في ملف index.js
    const server = app.listen(...);

    process.on('SIGTERM', () => {
      console.log('SIGTERM signal received: closing HTTP server');
      server.close(() => {
        console.log('HTTP server closed');
        // أغلق اتصال قاعدة البيانات هنا
        process.exit(0);
      });
    });
    ```
---