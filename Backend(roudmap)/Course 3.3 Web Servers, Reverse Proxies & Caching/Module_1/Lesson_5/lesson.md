## 🌐 الوحدة 1: خوادم الويب والوكلاء العكسيون (Reverse Proxies)

### 📘 الدرس 5: موازنة الأحمال (Load Balancing) مع Nginx

#### 🧠 **ماذا ستتعلم**
* ما هي موازنة الأحمال ولماذا هي مهمة للتوسع.
* كيفية تعريف مجموعة "منبع" (`upstream`) من الخوادم في Nginx.
* كيفية استخدام مجموعة `upstream` لتوزيع الطلبات.
* أشهر خوارزميات موازنة الأحمال (Round Robin, Least Connections).

---
### 🤔 1. الحاجة إلى التوسع: مشكلة الخادم الواحد
تطبيق Node.js يعمل افتراضيًا على عملية واحدة مرتبطة بنواة معالج (CPU core) واحدة. عندما يصبح تطبيقك شائعًا ويستقبل آلاف الطلبات في الثانية، يصبح هذا الخادم الواحد "عنق زجاجة"، مما يؤدي إلى بطء في الاستجابة أو حتى انهيار الخادم.

**الحل:** تشغيل **عدة نسخ** من تطبيق Node.js وتوزيع الطلبات عليها. هذا يسمى **التوسع الأفقي (Horizontal Scaling)**.

* **الفوائد:**
    * **أداء أفضل:** المزيد من الخوادم يمكنها التعامل مع عدد أكبر من المستخدمين.
    * **موثوقية وتوفر أعلى:** إذا توقفت إحدى نسخ التطبيق عن العمل، يقوم موازن الأحمال تلقائيًا بتوجيه الطلبات إلى النسخ السليمة، وبالتالي لا يشعر المستخدم بانقطاع الخدمة.

---
### ⚖️ 2. Nginx كموازن أحمال
Nginx هو أداة ممتازة للقيام بدور موازن الأحمال. بدلاً من تمرير الطلبات إلى خادم واحد، يمكننا إعداده لتوزيعها على مجموعة من الخوادم.

> **ببساطة:** بالعودة إلى مثال موظف الاستقبال (Nginx) في العيادة، تخيل أن العيادة وظفت الآن 3 أطباء (3 نسخ من تطبيقك) في نفس التخصص. يقوم موظف الاستقبال بتوجيه المرضى القادمين (الطلبات) إلى الأطباء الثلاثة بالتناوب، مما يضمن توزيع العمل بالتساوي وعدم إرهاق أي طبيب.

---
### 🔼 3. كتلة المنبع (The `upstream` Block)
لإعداد موازنة الأحمال، نستخدم كتلة `upstream`. هي تسمح لنا بتعريف "مجموعة" من الخوادم الخلفية وإعطائها اسمًا.

* **الصيغة:** توضع هذه الكتلة في ملف الإعداد الرئيسي، خارج أي كتلة `server`.
  ```nginx
  # تعريف مجموعة من خوادم التطبيق
  upstream my_app_backend {
      server localhost:3000;
      server localhost:3001;
      server localhost:3002;
  }
  ```

---
### ⚙️ 4. الإعداد الكامل لموازنة الأحمال
الآن، بدلاً من توجيه `proxy_pass` إلى عنوان IP ومنفذ معين، نوجهه إلى اسم مجموعة `upstream`.

```nginx
# تعريف مجموعة الخوادم
upstream my_app_backend {
    server localhost:3000;
    server localhost:3001;
}

# الخادم الافتراضي الذي يستقبل الطلبات
server {
    listen 80;
    server_name my-app.com;

    location / {
        # مرر الطلب إلى مجموعة الخوادم
        # سيقوم Nginx باختيار أحد الخوادم من المجموعة
        proxy_pass http://my_app_backend;

        # ... باقي ترويسات البروكسي ...
    }
}
```
عندما يرى Nginx توجيه `proxy_pass` إلى `http://my_app_backend`، سيعرف أنه يجب أن يختار أحد الخوادم من مجموعة `upstream` التي تحمل نفس الاسم ويوزع الطلب عليه.

---
### 🔀 5. خوارزميات موازنة الأحمال
كيف يختار Nginx الخادم الذي سيرسل إليه الطلب التالي؟

* **التدوير (Round Robin):**
    * **الكيفية:** هذه هي **الخوارزمية الافتراضية**. يقوم Nginx بتوزيع الطلبات على الخوادم بالترتيب. الطلب الأول يذهب إلى الخادم الأول، الثاني إلى الثاني، ثم يعود إلى الأول، وهكذا.
    * **متى تستخدم:** بسيطة وتعمل بشكل جيد عندما تكون جميع الخوادم متماثلة في الأداء.

* **أقل الاتصالات (Least Connections):**
    * **الكيفية:** يرسل Nginx الطلب الجديد إلى الخادم الذي لديه حاليًا أقل عدد من الاتصالات النشطة.
    * **متى تستخدم:** مفيدة جدًا عندما تستغرق بعض الطلبات وقتًا أطول للمعالجة من غيرها، حيث تمنع تكدس الطلبات الطويلة على خادم واحد.
    * **الصيغة:**
      ```nginx
      upstream my_app_backend {
          least_conn;
          server localhost:3000;
          server localhost:3001;
      }
      ```
---
