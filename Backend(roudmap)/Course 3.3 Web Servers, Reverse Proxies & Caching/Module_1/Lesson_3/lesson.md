## 🌐 الوحدة 1: خوادم الويب والوكلاء العكسيون (Reverse Proxies)

### 📘 الدرس 3: إعداد Nginx كوكيل عكسي (Reverse Proxy)

#### 🧠 **ماذا ستتعلم**

  * ما هو الوكيل العكسي (Reverse Proxy) بشكل عملي.
  * أين توجد ملفات إعداد Nginx الرئيسية.
  * كيفية إنشاء ملف إعداد جديد لتطبيق Node.js.
  * كيفية استخدام توجيه `proxy_pass` لتمرير الطلبات.
  * كيفية تفعيل الإعداد الجديد وإعادة تحميل Nginx.

-----

### 🤔 1. ما هو الوكيل العكسي؟ (مراجعة سريعة)

الوكيل العكسي هو خادم يجلس أمام خادم التطبيقات الخاص بك. هو يستقبل جميع الطلبات من الإنترنت، وبدلاً من معالجتها بنفسه، يقوم بتمريرها إلى خادم التطبيقات (مثل تطبيق Express الذي يعمل على منفذ 3000).

**هدفنا اليوم:** سنجعل Nginx يستمع على المنفذ 80 (منفذ HTTP القياسي الذي يستخدمه المتصفح افتراضيًا)، ويقوم بتوجيه أي طلب يصل إليه إلى تطبيق Express الذي يعمل على المنفذ 3000.

-----

### 📁 2. أين توجد ملفات إعداد Nginx؟

في معظم أنظمة لينكس (مثل Ubuntu)، يتم تنظيم ملفات إعداد Nginx كالتالي:

  * **/etc/nginx/nginx.conf**: ملف الإعداد الرئيسي. نادرًا ما نعدله مباشرة.
  * **/etc/nginx/sites-available/**: مجلد يحتوي على ملفات الإعداد لكل موقع أو تطبيق تريد استضافته. هنا نضع ملفاتنا.
  * **/etc/nginx/sites-enabled/**: مجلد يحتوي على **روابط رمزية (symbolic links)** إلى ملفات الإعداد الموجودة في `sites-available` التي نريد تفعيلها.

Nginx يقرأ فقط الملفات الموجودة في `sites-enabled`. هذه الطريقة تسمح لنا بتجهيز إعدادات عدة مواقع وتعطيلها أو تفعيلها بسهولة.

-----

### ✍️ 3. كتابة ملف الإعداد

#### **الخطوة 1: تجهيز تطبيق Node.js**

تأكد من أن لديك تطبيق Express بسيط يعمل. يمكنك استخدام التطبيق من الدورة السابقة. تأكد من أنه يعمل على منفذ داخلي مثل `3000`.

```javascript
// index.js
const express = require('express');
const app = express();
const PORT = 3000;

app.get('/', (req, res) => {
  res.send('Hello from my Express App!');
});

app.listen(PORT, () => console.log(`App listening on port ${PORT}`));
```

قم بتشغيله في نافذة طرفية منفصلة: `node index.js`.

#### **الخطوة 2: إنشاء ملف إعداد Nginx جديد**

في نافذة طرفية أخرى، سنقوم بإنشاء ملف إعداد جديد لتطبيقنا.

```bash
sudo nano /etc/nginx/sites-available/my-node-app
```

#### **الخطوة 3: كتابة الإعدادات**

الصق الكود التالي داخل الملف:

```nginx
server {
    # استمع على المنفذ 80 لطلبات HTTP
    listen 80;
    
    # اسم الخادم. localhost مناسب للتجارب المحلية
    # في الإنتاج، ستضع اسم النطاق الخاص بك هنا (e.g., example.com)
    server_name localhost;

    # عند وصول طلب للمسار الجذر (/)
    location / {
        # هذا هو السطر الأهم: قم بتمرير الطلب إلى تطبيق Node.js
        proxy_pass http://localhost:3000;

        # هذه الترويسات الإضافية مهمة لتمرير المعلومات الصحيحة
        # عن الطلب الأصلي إلى تطبيق Express
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

احفظ الملف واخرج (`Ctrl + O`, `Ctrl + X`).

-----

### ✅ 4. تفعيل الإعداد الجديد

1.  **تعطيل الموقع الافتراضي (اختياري لكن موصى به):** لتجنب أي تضارب، سنقوم بحذف الرابط الرمزي للموقع الافتراضي.
    ```bash
    sudo rm /etc/nginx/sites-enabled/default
    ```
2.  **تفعيل موقعنا الجديد (إنشاء الرابط الرمزي):**
    ```bash
    sudo ln -s /etc/nginx/sites-available/my-node-app /etc/nginx/sites-enabled/
    ```
3.  **اختبار الإعدادات وإعادة التحميل:**
      * أولاً، تحقق دائمًا من عدم وجود أخطاء إملائية في ملفات الإعداد:
        ```bash
        sudo nginx -t
        ```
        يجب أن ترى رسالة `syntax is ok` و `test is successful`.
      * إذا كان كل شيء على ما يرام، قم بتطبيق التغييرات عن طريق إعادة تحميل Nginx:
        ```bash
        sudo systemctl reload nginx
        ```

-----