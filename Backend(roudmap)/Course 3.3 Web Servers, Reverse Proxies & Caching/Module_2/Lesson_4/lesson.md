## โก ุงููุญุฏุฉ 2: ุงูุชุฎุฒูู ุงููุคูุช (Caching) ูุชุญุณูู ุงูุฃุฏุงุก

### ๐ ุงูุฏุฑุณ 4: ุชุทุจูู ุงูุชุฎุฒูู ุงููุคูุช ุจุงุณุชุฎุฏุงู Redis

#### ๐ง **ูุงุฐุง ุณุชุชุนูู**

  * ูุง ูู Redis ูููุงุฐุง ูู ููุงุณุจ ููุชุฎุฒูู ุงููุคูุช.
  * ุฏูุฑุฉ ุญูุงุฉ ุทูุจ ูุณุชุฎุฏู ุงููุงุด (Cache-Aside Pattern).
  * ููููุฉ ุงุณุชุฎุฏุงู Redis ูู ุชุทุจูู Node.js ูุชุฎุฒูู ูุชุงุฆุฌ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุคูุชูุง.
  * ููููุฉ ุฅุจุทุงู (invalidate) ุงููุงุด ุนูุฏ ุชุญุฏูุซ ุงูุจูุงูุงุช.

-----

### ๐ค 1. ูุง ูู Redisุ

Redis ูู ูุฎุฒู ุจูุงูุงุช **ูู ุงูุฐุงูุฑุฉ (in-memory)** ุณุฑูุน ููุบุงูุฉ. ูุธุฑูุง ูุฃูู ูุฎุฒู ุงูุจูุงูุงุช ูู ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู (RAM) ุจุฏูุงู ูู ุงููุฑุต ุงูุตูุจุ ูุฅู ุนูููุงุช ุงููุฑุงุกุฉ ูุงููุชุงุจุฉ ุชููู ุดุจู ููุฑูุฉ.

ุจูููุง ูููู ุงุณุชุฎุฏุงูู ููุงุนุฏุฉ ุจูุงูุงุชุ ูุฅู ุงุณุชุฎุฏุงูู ุงูุฃูุซุฑ ุดููุนูุง ูู ุชุทุจููุงุช ุงูููุจ ูู ูู **ูุงุด ููุฒุน (distributed cache)** ุนุงูู ุงูุฃุฏุงุก.

**ูู ุจูุฆุฉ ุงูุชุนูู ุงูุฎุงุตุฉ ุจูุง:** ููููู ุงูุชุฑุงุถ ุฃู ุฎุงุฏู Redis ูุนูู ููุชุงุญ ูุชุทุจูููุ ูุฃู ููุชุจุฉ `redis` ูู Node.js ูุชุงุญุฉ ููุงุณุชุฎุฏุงู.

-----

### โ๏ธ 2. ุฏูุฑุฉ ุนูู ุงููุงุด (The Cache-Aside Pattern)

ูุฐุง ูู ุงูููุท ุงูุฃูุซุฑ ุดููุนูุง ูุงุณุชุฎุฏุงู ุงููุงุด ูุน ูุงุนุฏุฉ ุจูุงูุงุช. ุนูุฏ ูุตูู ุทูุจ ูุจูุงูุงุช ูุนููุฉ (ูุซู `GET /users/123`):

1.  **ุงุจุญุซ ูู ุงููุงุด ุฃููุงู:** ูุญุงูู ุงูุชุทุจูู ุฌูุจ ุงูุจูุงูุงุช ูู Redis ุจุงุณุชุฎุฏุงู ููุชุงุญ ูุฑูุฏ (ูุซู `user:123`).
2.  **ุฅุตุงุจุฉ ุงููุงุด (Cache Hit):** ุฅุฐุง ูุงูุช ุงูุจูุงูุงุช ููุฌูุฏุฉ ูู Redisุ ูุชู ุฅุฑุฌุงุนูุง ูุจุงุดุฑุฉ ุฅูู ุงูุนููู. **ุงูุชูุช ุงูุนูููุฉ.** (ุงูุทุฑูู ุงูุณุฑูุน โก)
3.  **ุฅุฎูุงู ุงููุงุด (Cache Miss):** ุฅุฐุง ูู ุชูู ุงูุจูุงูุงุช ููุฌูุฏุฉ ูู Redis...
    ุฃ. ูููู ุงูุชุทุจูู ุจุฅุฌุฑุงุก ุงูุงุณุชุนูุงู ุงููููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฑุฆูุณูุฉ (PostgreSQL).
    ุจ. **ูุฎุฒู ุงููุชูุฌุฉ ูู Redis** ูุน ูุฏุฉ ุตูุงุญูุฉ (TTL - Time To Live) ุญุชู ูุชู ุงุณุชุฎุฏุงููุง ูู ุงูุทูุจุงุช ุงููุณุชูุจููุฉ.
    ุฌ. ูุชู ุฅุฑุฌุงุน ุงูุจูุงูุงุช (ุงูุชู ุชู ุฌูุจูุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช) ุฅูู ุงูุนููู. (ุงูุทุฑูู ุงูุจุทูุก ๐ข)

-----

### โ๏ธ 3. ูุซุงู ุนููู: ุงูุชุฎุฒูู ุงููุคูุช ูุทูุจุงุช API

ูููุชุฑุถ ุฃู ูุฏููุง ููุทุฉ ููุงูุฉ `GET /books/:id` ุชุฌูุจ ูุชุงุจูุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช. ุณูุถูู ุฅูููุง ููุทู ุงูุชุฎุฒูู ุงููุคูุช ุจุงุณุชุฎุฏุงู Redis.

```javascript
const express = require('express');
const redis = require('redis');
const db = require('./database'); // ูุงุนุฏุฉ ุจูุงูุงุชูุง ุงูุฑุฆูุณูุฉ

const app = express();

// ุงูุชุฑุถ ุฃู Redis ูุนูู ุนูู ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ
const redisClient = redis.createClient();
redisClient.connect(); // ูู ุจุงูุงุชุตุงู ุจู Redis ุนูุฏ ุจุฏุก ุงูุชุทุจูู

app.get('/books/:id', async (req, res) => {
  const { id } = req.params;
  const cacheKey = `book:${id}`; // ููุชุงุญ ูุฑูุฏ ูููุงุด

  try {
    // 1. ุงุจุญุซ ูู ุงููุงุด ุฃููุงู
    const cachedBook = await redisClient.get(cacheKey);

    if (cachedBook) {
      // 2. ุฅุตุงุจุฉ ุงููุงุด (Cache Hit)
      console.log('Serving from cache!');
      return res.json(JSON.parse(cachedBook));
    }

    // 3. ุฅุฎูุงู ุงููุงุด (Cache Miss) - ุงุฐูุจ ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    console.log('Serving from database...');
    const { rows } = await db.query('SELECT * FROM books WHERE id = $1', [id]);
    const book = rows[0];

    if (!book) {
      return res.status(404).send('Book not found');
    }

    // 4. ุฎุฒูู ุงููุชูุฌุฉ ูู Redis ูุน ุตูุงุญูุฉ ููุฏุฉ ุณุงุนุฉ (3600 ุซุงููุฉ)
    await redisClient.set(cacheKey, JSON.stringify(book), {
      EX: 3600, // EX for seconds
    });
    
    res.json(book);

  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

app.listen(3000);
```

-----

### ๐๏ธ 4. ุฅุจุทุงู ุงููุงุด (Cache Invalidation)

ูุฐุง ูู ุงูุฌุฒุก ุงูุญุงุณู\! ุฅุฐุง ูุงู ูุณุชุฎุฏู ุจุชุญุฏูุซ ูุชุงุจ (`PUT /books/:id`)ุ ูุฅู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูู ุงููุงุด ููุฐุง ุงููุชุงุจ ุชุตุจุญ ูุฏููุฉ (stale). ูุฌุจ ุนูููุง ุญุฐููุง.

**ูู ูุนุงูุฌ ุทูุจ `PUT`:**

```javascript
app.put('/books/:id', async (req, res) => {
    const { id } = req.params;
    const { title, author } = req.body;
    const cacheKey = `book:${id}`;

    // 1. ูู ุจุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฑุฆูุณูุฉ ุฃููุงู
    const { rows } = await db.query(
        'UPDATE books SET title = $1, author = $2 WHERE id = $3 RETURNING *',
        [title, author, id]
    );

    // 2. ุฅุฐุง ูุฌุญ ุงูุชุญุฏูุซุ ูู ุจุฅุจุทุงู (ุญุฐู) ุงููุงุด
    await redisClient.del(cacheKey);
    console.log('Cache invalidated for book:', id);

    res.json(rows[0]);
});
```

ุงูุขูุ ุฃู ุทูุจ `GET` ุชุงูู ูููุณ ุงููุชุงุจ ุณูุฌุฏ ุงููุงุด ูุงุฑุบูุง (Cache Miss)ุ ูุณูุฌูุจ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ ุซู ูุนูุฏ ุชุฎุฒูููุง ูู ุงููุงุด.

-----