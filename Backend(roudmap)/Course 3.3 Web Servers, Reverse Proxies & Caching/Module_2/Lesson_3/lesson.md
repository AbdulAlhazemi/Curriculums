## ⚡ الوحدة 2: التخزين المؤقت (Caching) وتحسين الأداء

### 📘 الدرس 3: ترويسات HTTP للتخزين المؤقت

#### 🧠 **ماذا ستتعلم**
* دور ترويسات HTTP في التحكم بسلوك التخزين المؤقت.
* الترويسة الرئيسية `Cache-Control` وأشهر توجيهاتها.
* الترويسة القديمة `Expires`.
* مفهوم التحقق من صحة الكاش (Cache Validation) باستخدام `ETag` و `Last-Modified`.

---
### 🤔 1. كيف يتواصل الخادم مع الكاش؟
لقد علمنا أن المتصفحات وشبكات CDN يمكنها تخزين نسخ من المحتوى. لكن كيف تعرف هذه الأنظمة **ماذا** يجب أن تخزن، **ولمدة كم**، ومتى تصبح نسختها **قديمة**؟

**الإجابة:** يقوم الخادم بإرسال **تعليمات** إلى أنظمة الكاش هذه عبر **ترويسات استجابة HTTP (HTTP Response Headers)** محددة. يقرأ المتصفح أو الـ CDN هذه الترويسات ويتصرف بناءً عليها.

---
### 👑 2. الترويسة الأهم: `Cache-Control`
هذه هي الترويسة الحديثة والأساسية لتحديد سياسات التخزين المؤقت. هي مرنة جدًا وتستخدم "توجيهات" (directives) للتحكم في السلوك.

| التوجيه | الوصف |
| :--- | :--- |
| **`public`** | يمكن تخزين الاستجابة بواسطة أي كاش (المتصفح، الـ CDN، إلخ). |
| **`private`**| الاستجابة مخصصة لمستخدم واحد ويجب تخزينها فقط في الكاش الخاص به (المتصفح). |
| **`max-age=<seconds>`**| أهم توجيه. يحدد المدة الزمنية بالثواني التي يعتبر فيها المورد "حديثًا" وصالحًا للاستخدام من الكاش. (مثال: `max-age=86400` يعني التخزين لمدة يوم واحد). |
| **`no-cache`** | **(مفهوم خاطئ شائع)** هذا **لا يعني** "لا تخزن". بل يعني أن الكاش **يجب أن يتحقق دائمًا من الخادم الأصلي (Revalidate)** قبل استخدام النسخة المخبأة للتأكد من أنها لم تتغير. |
| **`no-store`** | هذا هو التوجيه الذي يعني حقًا **"لا تخزن أبدًا"**. يمنع تخزين الاستجابة في أي كاش. يستخدم للمعلومات الحساسة جدًا. |

**مثال:**
`Cache-Control: public, max-age=3600`
(هذه الاستجابة عامة ويمكن تخزينها في أي كاش لمدة ساعة واحدة).

---
### 📜 3. الترويسة القديمة: `Expires`
هذه هي الطريقة الأقدم لتحديد مدة صلاحية الكاش. تحتوي على تاريخ ووقت محددين تصبح بعدهما الاستجابة قديمة.
`Expires: Fri, 13 Jun 2025 10:00:00 GMT`

**المشكلة:** تعتمد على دقة تزامن ساعات الخادم والعميل. توجيه `max-age` في `Cache-Control` هو نسبي وبالتالي أكثر موثوقية ومفضلية. إذا كانت كلتا الترويستين موجودتين، فإن `Cache-Control` لها الأسبقية.

---
### ✅ 4. التحقق من صحة الكاش (Cache Validation)
ماذا يحدث بعد انتهاء `max-age`؟ هل يجب على المتصفح إعادة تحميل الملف بالكامل؟ ليس بالضرورة. يمكنه أن يسأل الخادم: "لدي نسخة من هذا الملف، هل لا تزال صالحة؟".

هناك طريقتان رئيسيتان للتحقق:

#### **`ETag` (Entity Tag)**
1.  **الخادم يرسل ETag:** عند إرسال المورد، يرسل الخادم ترويسة `ETag` تحتوي على معرف فريد لإصدار هذا المورد (مثل هاش لمحتوى الملف). `ETag: "v2-a1b2c3d4"`
2.  **العميل يرسل If-None-Match:** عندما يريد المتصفح التحقق من نسخته، يرسل نفس الـ ETag في ترويسة طلب جديدة اسمها `If-None-Match`.
3.  **الخادم يقارن:** يقارن الخادم الـ ETag القادم مع الـ ETag الحالي للملف.
    * إذا تطابقا، يرد الخادم باستجابة `304 Not Modified` (فارغة وصغيرة جدًا).
    * إذا اختلفا، يرد الخادم باستجابة `200 OK` مع النسخة الجديدة الكاملة للملف.

#### **`Last-Modified`**
آلية أقدم تعمل بنفس المبدأ ولكن باستخدام تواريخ التعديل. `ETag` يعتبر أكثر دقة وقوة.

---

