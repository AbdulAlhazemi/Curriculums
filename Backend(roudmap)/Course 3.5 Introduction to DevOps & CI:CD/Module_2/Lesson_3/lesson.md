## ⚙️ الوحدة 2: التطبيق العملي باستخدام GitHub Actions

### 📘 الدرس 3: إنشاء خط أنابيب CD أساسي (مفاهيميًا)

#### 🧠 **ماذا ستتعلم**
* الهدف من خط أنابيب النشر المستمر (CD).
* كيفية هيكلة سير عمل يحتوي على مهام متعددة ومعتمدة على بعضها (`test` و `deploy`).
* كيفية استخدام `needs` لإنشاء تبعيات بين المهام.
* كيفية استخدام الشروط `if` لتشغيل مهمة النشر على الفرع الرئيسي فقط.
* الخطوات المفاهيمية لعملية نشر حقيقية (SSH, git pull, pm2).

---
### 🤔 1. من التكامل المستمر إلى النشر المستمر
في الدرس السابق، قمنا ببناء خط أنابيب للتكامل المستمر (CI). وظيفته هي التأكد من أن الكود في فرعنا الرئيسي يتم بناؤه واختباره بنجاح دائمًا. هذا يتركنا مع نسخة "جيدة" من الكود جاهزة للإصدار.

**الخطوة التالية:** الآن، نريد أن نأخذ هذا الكود الذي نجح في الاختبارات و**ننشره تلقائيًا** على خادمنا ليصبح متاحًا للمستخدمين. هذه هي وظيفة النشر المستمر (CD).

---
### 🏗️ 2. هيكلة سير عمل النشر المستمر
عادةً، يتكون خط أنابيب CD من مهمتين رئيسيتين أو أكثر تعمل بالتسلسل:
1.  **مهمة الاختبار (`test`):** تقوم بنفس ما فعله خط أنابيب CI: بناء الكود وتشغيل الاختبارات.
2.  **مهمة النشر (`deploy`):** تعمل **فقط إذا نجحت مهمة الاختبار**. هي مسؤولة عن أخذ الكود ونشره على الخادم.

#### **الكلمة المفتاحية `needs`**
نستخدم `needs` لإنشاء تبعية بين المهام. `needs: test` داخل مهمة `deploy` تعني أن مهمة `deploy` لن تبدأ إلا بعد اكتمال مهمة `test` بنجاح.

#### **الشرط `if`**
نريد أن تتم عملية النشر فقط عند تحديث الفرع الرئيسي (`main`)، وليس عند كل دفعة (`push`) إلى أي فرع آخر. نستخدم `if` لتحقيق ذلك.
`if: github.ref == 'refs/heads/main'`

---
### 📝 3. ملف سير العمل الكامل (مفاهيميًا)
هذا مثال على ملف `cd.yml` يجمع بين CI و CD.

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  # المهمة الأولى: بناء واختبار التطبيق
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      - run: npm ci
      - run: npm test

  # المهمة الثانية: نشر التطبيق
  deploy:
    runs-on: ubuntu-latest
    # اجعل هذه المهمة تعتمد على نجاح مهمة 'test'
    needs: test
    # شغل هذه المهمة فقط عند الدفع إلى فرع main
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to production server
        # هذه الخطوة مفاهيمية. النشر الحقيقي يتطلب مفاتيح SSH وأسرار.
        # سنتعلم عن الأسرار في الدرس القادم.
        run: |
          echo "🚀 Starting deployment..."
          echo "1. Connecting to server via SSH..."
          echo "2. Pulling latest changes from main branch..."
          echo "3. Installing production dependencies..."
          echo "4. Restarting the application with PM2..."
          echo "✅ Deployment successful!"
```

---
### SSH 4. كيف يبدو النشر الفعلي؟
الخطوات التي تم تبسيطها في المثال أعلاه، في العالم الحقيقي، تتم عادةً كالتالي باستخدام إجراءات (Actions) جاهزة:
1.  **الاتصال بالخادم (SSH):** يتم استخدام Action (مثل `appleboy/ssh-action`) مع مفاتيح SSH المخزنة في "أسرار" GitHub للاتصال بالخادم بأمان.
2.  **سحب التغييرات:** يتم تنفيذ أمر `git pull` على الخادم لجلب أحدث نسخة من الكود.
3.  **تثبيت التبعيات:** يتم تنفيذ `npm install --production` لتثبيت التبعيات الضرورية للإنتاج فقط.
4.  **إعادة تشغيل التطبيق:** يتم استخدام مدير عمليات مثل `pm2` لإعادة تشغيل التطبيق دون انقطاع (`pm2 reload app`).

---
