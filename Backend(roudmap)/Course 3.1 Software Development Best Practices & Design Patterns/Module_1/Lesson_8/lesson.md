## 📐 الوحدة 1: مبادئ الكود النظيف وأنماط التصميم

### 📘 الدرس 8: تقنيات إعادة الهيكلة (Refactoring)

#### 🧠 **ماذا ستتعلم**
* ما هي إعادة الهيكلة (Refactoring) وما هو الغرض منها.
* ما هي "روائح الكود" (Code Smells) وكيفية اكتشافها.
* أشهر تقنيات إعادة الهيكلة مثل "استخلاص دالة" و "إعادة تسمية متغير".
* أهمية وجود الاختبارات (Tests) قبل البدء في إعادة الهيكلة.

---
### 🤔 1. ما هي إعادة الهيكلة (Refactoring)؟
إعادة الهيكلة هي عملية **تحسين الهيكل الداخلي للكود الموجود**، دون **تغيير سلوكه الخارجي**. الهدف ليس إضافة ميزات جديدة أو إصلاح أخطاء، بل جعل الكود أنظف، أسهل في الفهم، وأكثر قابلية للصيانة في المستقبل.

> **ببساطة:** تخيل أنك قمت ببناء قطعة أثاث. هي تعمل بشكل جيد. إعادة الهيكلة تشبه العودة لورشة العمل الخاصة بك بعد ذلك، وتنظيف الأدوات، ووضع البراغي المتبقية في علب مصنفة، وتنظيم كل شيء. قطعة الأثاث لم تتغير، لكن ورشة عملك أصبحت الآن أفضل وأسهل للعمل فيها في مشروعك القادم.

---
### 👃 2. اكتشاف "روائح الكود" (Code Smells)
"رائحة الكود" ليست خطأً برمجيًا (bug). إنها مجرد **مؤشر أو علامة** في الكود قد تدل على وجود مشكلة أعمق في التصميم. عندما تشم "رائحة"، فهذه إشارة إلى أن هذا الجزء من الكود قد يحتاج إلى إعادة هيكلة.

* **أشهر روائح الكود:**
    * **الدالة الطويلة (Long Method):** دالة تقوم بالعديد من المهام المختلفة. (تنتهك مبدأ المسؤولية الواحدة).
    * **الكود المكرر (Duplicated Code):** نفس كتلة الكود تظهر في أماكن متعددة. (تنتهك مبدأ DRY).
    * **الأسماء الغامضة (Mysterious Names):** متغيرات أو دوال بأسماء غير واضحة مثل `data`, `proc`, `a`, `b`.
    * **الكلاس الضخم (Large Class):** كلاس يحاول أن يفعل كل شيء، ويُعرف أحيانًا بـ "الكائن الإلهي" (God Object).
    * **قائمة المعاملات الطويلة (Long Parameter List):** دالة تأخذ عددًا كبيرًا جدًا من المعاملات.

---
### 🔧 3. أشهر تقنيات إعادة الهيكلة

#### **أ. استخلاص دالة (Extract Method/Function)**
هذه هي التقنية الأكثر شيوعًا. إذا كان لديك جزء من الكود داخل دالة طويلة يمكن تجميعه منطقيًا، يمكنك "استخلاصه" ووضعه في دالة جديدة خاصة به مع اسم واضح.

* **قبل:**
    ```javascript
    function printInvoice(order) {
      // ... 15 سطراً لحساب الإجمالي ...
      console.log(`Subtotal: ${total}`);
      // ... 10 أسطر لطباعة تفاصيل العميل ...
      console.log(`Customer: ${order.customer.name}`);
    }
    ```
* **بعد:**
    ```javascript
    function printOrderTotal(order) { /* ... */ }
    function printCustomerDetails(order) { /* ... */ }

    function printInvoice(order) {
      printOrderTotal(order);
      printCustomerDetails(order);
    }
    ```
#### **ب. إعادة تسمية متغير/دالة (Rename Variable/Function)**
إذا كان الاسم لا يعبر عن القصد، قم بتغييره. محررات الكود الحديثة تجعل هذه العملية آمنة وسهلة.

* **قبل:** `let d = 24 * 60 * 60 * 1000;`
* **بعد:** `const MILLISECONDS_IN_A_DAY = 24 * 60 * 60 * 1000;`

#### **ج. استبدال الأرقام السحرية بثوابت مسماة (Replace Magic Number with Named Constant)**
"الرقم السحري" هو أي رقم في الكود ليس له معنى واضح.

* **قبل:** `const finalPrice = basePrice * 1.15;` (ما هو `1.15`؟)
* **بعد:**
    ```javascript
    const VAT_RATE = 0.15;
    const finalPrice = basePrice * (1 + VAT_RATE);
    ```

---
### ⚖️ 4. القاعدة الذهبية لإعادة الهيكلة
**يجب أن يكون لديك مجموعة جيدة من الاختبارات الآلية (Automated Tests) قبل البدء في إعادة الهيكلة.**

الاختبارات تعمل كـ "شبكة أمان". بعد كل تغيير صغير تقوم به، يمكنك تشغيل الاختبارات للتأكد من أنك لم تكسر أي وظيفة موجودة عن طريق الخطأ. إعادة الهيكلة بدون اختبارات هي عملية محفوفة بالمخاطر.

---
