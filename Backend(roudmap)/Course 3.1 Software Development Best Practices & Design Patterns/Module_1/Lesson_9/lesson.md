## 📐 الوحدة 1: مبادئ الكود النظيف وأنماط التصميم

### 📘 الدرس 9: البرمجة الدفاعية والتعامل مع الأخطاء

#### 🧠 **ماذا ستتعلم**
* ما هي البرمجة الدفاعية وما هو الهدف منها.
* أهمية التحقق من صحة المدخلات (Input Validation).
* استخدام التأكيدات (Assertions) لفرض افتراضات الكود.
* استراتيجيات متقدمة للتعامل مع الأخطاء تتجاوز `try-catch` الأساسي.

---
### 🛡️ 1. ما هي البرمجة الدفاعية؟
البرمجة الدفاعية هي أسلوب في كتابة الكود يهدف إلى ضمان استمرار عمل البرنامج بشكل متوقع حتى في ظل ظروف غير متوقعة أو عند استخدامه بطرق خاطئة. الفكرة هي أنك كمبرمج يجب أن تتوقع المشاكل المحتملة وتكتب كودًا يتصرف بأمان عند حدوثها.

> **ببساطة:** إنها مثل **القيادة الدفاعية**. أنت لا تركز فقط على قيادتك، بل تتوقع أيضًا أن السائقين الآخرين قد يرتكبون أخطاء (مثل تجاوز إشارة حمراء)، وتكون مستعدًا للتصرف لتجنب الحوادث. في البرمجة، أنت تتوقع بيانات سيئة، حالات غير صالحة، واستخدامًا غير صحيح لدوالك.

---
### 🚪 2. حراسة الدوال: التحقق من صحة المدخلات
**القاعدة الأساسية:** "لا تثق أبدًا بالمدخلات". هذا ينطبق على كل شيء: مدخلات المستخدم، البيانات القادمة من API، أو حتى البيانات من أجزاء أخرى من نظامك.

**نمط "الحارس" (Guard Clause):**
بدلاً من وضع منطقك الرئيسي داخل كتلة `if` كبيرة، قم بمعالجة الحالات غير الصالحة أولاً في بداية الدالة واخرج مبكرًا. هذا يجعل المنطق الرئيسي لدالتك أكثر وضوحًا وأقل تداخلاً.

* **مثال سيئ (تداخل الشروط):**
    ```javascript
    function processOrder(user, items) {
      if (user) {
        if (items && items.length > 0) {
          // ... المنطق الرئيسي هنا ...
          // ... 20 سطرًا من الكود ...
        } else {
          console.error("No items in order.");
        }
      } else {
        console.error("User is required.");
      }
    }
    ```
* **مثال جيد (استخدام الحراس):**
    ```javascript
    function processOrder(user, items) {
      if (!user) {
        throw new Error("User is required to process an order.");
      }
      if (!items || items.length === 0) {
        throw new Error("Cannot process an empty order.");
      }
      // ... المنطق الرئيسي هنا واضح وغير متداخل ...
    }
    ```
---
### 📢 3. التأكيدات (Assertions): فرض افتراضاتك
التأكيد هو عبارة برمجية تتحقق من شرط يُفترض أن يكون **صحيحًا دائمًا** في نقطة معينة من الكود. إذا كان الشرط خاطئًا، فهذا يعني وجود **خطأ برمجي (bug)**، ويقوم التأكيد بإطلاق خطأ فوري.

* **الغرض:** تستخدم لاكتشاف أخطاء المبرمجين، وليس أخطاء المستخدمين أو البيانات الخارجية. هي توثق افتراضاتك حول حالة البرنامج.
* **مثال:**
    ```javascript
    function calculateFinalPrice(cart) {
      // نفترض أنه من المستحيل استدعاء هذه الدالة بعربة فارغة.
      // إذا حدث ذلك، فهو خطأ منطقي في مكان آخر.
      console.assert(cart !== null && cart.items.length > 0, "Cart cannot be empty here.");

      // ... منطق الحساب ...
    }
    ```
> **ملاحظة:** غالبًا ما يتم تعطيل التأكيدات في بيئات الإنتاج لتحسين الأداء، فهي مخصصة بشكل أساسي لمرحلة التطوير والتصحيح.

---
### 🚑 4. استراتيجيات التعامل مع الأخطاء بأناقة

* **الفشل السريع (Fail Fast):** من الأفضل غالبًا أن يتوقف البرنامج فورًا عند حدوث خطأ فادح وغير متوقع، بدلاً من الاستمرار في حالة فاسدة وغير متوقعة. هذا يجعل اكتشاف الأخطاء وتصحيحها أسهل بكثير.
* **استخدام أنواع أخطاء مخصصة:** بدلاً من إطلاق `new Error()` دائمًا، قم بإنشاء أنواع أخطاء خاصة بك (مثل `ValidationError`, `AuthenticationError`). هذا يسمح لكتل `catch` بمعالجة كل نوع من الأخطاء بطريقة مختلفة.
    ```javascript
    try {
      // ...
    } catch (error) {
      if (error instanceof ValidationError) {
        // أظهر رسالة خطأ للمستخدم
      } else {
        // سجّل الخطأ كخطأ فادح في الخادم
      }
    }
    ```
* **إرجاع قيم افتراضية:** في بعض الحالات، بدلاً من إطلاق خطأ، يكون من الأفضل إرجاع قيمة افتراضية آمنة (مثل مصفوفة فارغة `[]` إذا لم يتم العثور على نتائج بحث).

---
