## 🗃️ الوحدة 2: استعلامات SQL المتقدمة وتصميم قواعد البيانات

### 📘 الدرس 2: الاستعلامات الفرعية و CTEs

#### 🧠 **ماذا ستتعلم**
* ما هو الاستعلام الفرعي (Subquery) وكيفية استخدامه.
* استخدام الاستعلامات الفرعية في جمل `WHERE`, `FROM`, و `SELECT`.
* ما هو تعبير الجدول الشائع (Common Table Expression - CTE) وكيف يبسط الاستعلامات المعقدة.
* مزايا استخدام CTEs لتحسين قابلية قراءة الكود.

---
### 🤔 1. ما هو الاستعلام الفرعي (Subquery)؟
الاستعلام الفرعي (يُعرف أيضًا بالاستعلام المتداخل أو الداخلي) هو استعلام `SELECT` يتم كتابته **داخل** استعلام SQL آخر. يتم تنفيذ الاستعلام الداخلي أولاً، وتُستخدم نتيجته بواسطة الاستعلام الخارجي.

> **ببساطة:** إنه مثل طرح سؤال يعتمد على إجابة سؤال آخر. على سبيل المثال: "من هم المؤلفون الذين كتبوا الكتب التي حصلت على تقييم أعلى من 4 نجوم؟". عليك أولاً أن تجد "الكتب التي حصلت على تقييم أعلى من 4 نجوم"، ثم تستخدم هذه القائمة للعثور على مؤلفيها.

---
### ⚙️ 2. استخدامات الاستعلامات الفرعية
سنستخدم نفس جدولي `authors` و `books` من الدرس السابق.

#### **أ. في جملة `WHERE` (الأكثر شيوعًا)**
تُستخدم لفلترة بيانات الاستعلام الخارجي بناءً على نتيجة الاستعلام الداخلي.

**مثال:** جلب جميع الكتب التي كتبها 'George Orwell'.
```sql
SELECT title
FROM books
WHERE author_id = (SELECT id FROM authors WHERE name = 'George Orwell');
```
* **الخطوة 1:** يُنفذ الاستعلام الداخلي `(SELECT id FROM authors WHERE name = 'George Orwell')` أولاً ويُرجع القيمة `1`.
* **الخطوة 2:** يصبح الاستعلام الخارجي `SELECT title FROM books WHERE author_id = 1;`.

**مثال مع `IN`:** جلب أسماء جميع المؤلفين الذين لديهم كتب.
```sql
SELECT name
FROM authors
WHERE id IN (SELECT DISTINCT author_id FROM books);
```
---
#### **ب. في جملة `FROM`**
يمكنك استخدام نتيجة استعلام فرعي كجدول مؤقت تجري عليه عمليات أخرى.

**مثال:** حساب متوسط عدد الكتب لكل مؤلف.
```sql
SELECT AVG(book_count) AS average_books_per_author
FROM (
    -- هذا الاستعلام الفرعي ينشئ جدولًا مؤقتًا
    SELECT author_id, COUNT(*) AS book_count
    FROM books
    GROUP BY author_id
) AS derived_table; -- يجب دائمًا إعطاء اسم مستعار (alias) للجدول المشتق
```
---
### ✨ 3. تعبيرات الجداول الشائعة (Common Table Expressions - CTEs)
الـ CTE هو بديل أكثر تنظيمًا وقراءة للاستعلامات الفرعية المعقدة. يسمح لك بإنشاء نتيجة مؤقتة وتسميتها، ثم استخدامها في استعلام لاحق.

يتم تعريف الـ CTE باستخدام جملة `WITH`.

**مثال:** إعادة كتابة مثال حساب المتوسط باستخدام CTE.
```sql
WITH author_book_counts AS (
    -- هذا هو الـ CTE، وهو بمثابة جدول مؤقت اسمه author_book_counts
    SELECT author_id, COUNT(*) AS book_count
    FROM books
    GROUP BY author_id
)
-- الآن يمكنك استخدام هذا الجدول المؤقت في استعلامك الرئيسي
SELECT AVG(book_count) AS average_books_per_author
FROM author_book_counts;
```
لاحظ كيف أن الكود أصبح **أكثر وضوحًا** وسهولة في القراءة، حيث تم فصل منطق حساب عدد الكتب لكل مؤلف في خطوة منطقية خاصة به.

---
