## 🗃️ الوحدة 2: استعلامات SQL المتقدمة وتصميم قواعد البيانات

### 📘 الدرس 5: المعاملات (Transactions) وخصائص ACID

#### 🧠 **ماذا ستتعلم**
* ما هي معاملة قاعدة البيانات (Database Transaction).
* لماذا تعتبر المعاملات ضرورية للعمليات التي تتضمن خطوات متعددة.
* معنى خصائص ACID الأربع: Atomicity, Consistency, Isolation, Durability.

---
### 🤔 1. المشكلة: عمليات متعددة الخطوات
تخيل عملية تحويل بنكي بسيطة: تريد تحويل 100 ريال من حسابك (A) إلى حساب صديقك (B). هذه العملية تتطلب خطوتين في قاعدة البيانات:
1.  **خصم** 100 ريال من رصيد الحساب A.
2.  **إضافة** 100 ريال إلى رصيد الحساب B.

**ماذا لو حدث انقطاع في الكهرباء أو عطل في النظام *بعد* الخطوة 1 وقبل الخطوة 2؟**
لقد تم خصم المبلغ من حسابك، لكنه لم يصل أبدًا إلى حساب صديقك. لقد "اختفى" المال، وأصبحت قاعدة البيانات في حالة غير متسقة وغير صحيحة.

---
### 💡 2. الحل: المعاملة (The Transaction)
المعاملة هي مجموعة من عملية SQL واحدة أو أكثر يتم تنفيذها **كوحدة عمل منطقية واحدة**. المبدأ الأساسي للمعاملة هو **"إما أن تنجح جميعها، أو تفشل جميعها" (All or Nothing)**.

إذا فشلت أي خطوة داخل المعاملة، يتم التراجع عن جميع الخطوات السابقة (تسمى هذه العملية **Rollback**)، وتعود قاعدة البيانات إلى حالتها الأصلية قبل بدء المعاملة. إذا نجحت جميع الخطوات، يتم حفظ التغييرات بشكل دائم (تسمى هذه العملية **Commit**).

**أوامر SQL للمعاملات:**
* `BEGIN;`: لبدء معاملة جديدة.
* `COMMIT;`: لحفظ جميع التغييرات بشكل دائم.
* `ROLLBACK;`: للتراجع عن جميع التغييرات التي تمت منذ بداية المعاملة.

**مثال التحويل البنكي داخل معاملة:**
```sql
BEGIN;

UPDATE accounts SET balance = balance - 100 WHERE id = 'A';
UPDATE accounts SET balance = balance + 100 WHERE id = 'B';

-- إذا تمت العمليتان بنجاح، قم بالحفظ
COMMIT;
```
إذا حدث أي خطأ بين عمليتي `UPDATE`، يمكن إصدار أمر `ROLLBACK` لإلغاء الخصم من الحساب A.

---
### 🧪 3. خصائص ACID
ACID هو اختصار يصف الخصائص الأربع التي تضمنها المعاملات في أنظمة قواعد البيانات للحفاظ على سلامة البيانات.

| الحرف | الخاصية | الوصف | مثال التحويل البنكي |
|:---:|:---|:---|:---|
| **A** | **Atomicity (الذرية)** | "إما الكل أو لا شيء". المعاملة وحدة لا تتجزأ. | التحويل إما أن يكتمل (خصم وإضافة)، أو يفشل بالكامل (لا يتغير أي حساب). |
| **C** | **Consistency (الاتساق)**| تضمن المعاملة أن قاعدة البيانات تنتقل من حالة صحيحة إلى حالة صحيحة أخرى. | يجب أن يظل إجمالي الأموال في البنك كما هو قبل وبعد التحويل. لا يمكن إنشاء أو تدمير المال. |
| **I** | **Isolation (العزل)** | المعاملات المتزامنة معزولة عن بعضها البعض. نتيجة تنفيذ عدة معاملات في نفس الوقت يجب أن تكون مماثلة لنتيجة تنفيذها واحدة تلو الأخرى. | إذا حاول شخصان سحب أموال من نفس الحساب في نفس اللحظة، يجب أن تنتظر إحدى العمليتين الأخرى حتى تنتهي لمنع التضارب. |
| **D** | **Durability (الاستمرارية)**| بمجرد أن يتم عمل `COMMIT` للمعاملة، فإن تغييراتها تكون دائمة ومحفوظة، حتى في حالة انقطاع التيار الكهربائي أو تعطل النظام. | بمجرد أن يؤكد البنك أن التحويل قد تم، فإن هذه الحقيقة لا يمكن أن تضيع أو يتم التراجع عنها بسبب عطل فني. |

---
