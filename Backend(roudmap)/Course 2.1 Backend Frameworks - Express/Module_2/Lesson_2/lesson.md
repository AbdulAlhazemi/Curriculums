## 🚀 الوحدة 2: البرمجيات الوسيطة ودورة الطلب/الاستجابة

### 📘 الدرس 2: التعامل مع الأخطاء في Express

#### 🧠 **ماذا ستتعلم**
* كيف يتعامل Express مع الأخطاء بشكل افتراضي.
* كيفية إنشاء Middleware مخصص للتعامل مع الأخطاء.
* الصيغة الخاصة لدالة Middleware معالجة الأخطاء (`err, req, res, next`).
* كيفية إطلاق معالج الأخطاء باستخدام `next(error)`.
* كيفية التعامل مع أخطاء "404 غير موجود".

---
### 🤔 1. كيف يتعامل Express مع الأخطاء افتراضيًا؟
بشكل افتراضي، إذا حدث خطأ في الكود **المتزامن (synchronous)** داخل أحد مساراتك، سيقوم Express بالتقاطه وإرسال استجابة خطأ `500 Internal Server Error` إلى العميل.

**المشكلة:** Express **لا يلتقط الأخطاء التي تحدث في الكود غير المتزامن (asynchronous)** بشكل تلقائي (مثل الأخطاء داخل دوال الـ callback أو `.then()` الخاصة بالـ Promises). إذا حدث خطأ هناك ولم تتعامل معه، سيتوقف الخادم بالكامل (crash).

---
### ➡️ 2. تمرير الأخطاء باستخدام `next(error)`
لحل مشكلة الأخطاء غير المتزامنة، يجب عليك التقاطها بنفسك وتمريرها إلى دالة `next()`.

عندما يتم استدعاء `next()` مع أي وسيط (argument) بداخلها، يفترض Express أن هذا الوسيط هو خطأ. سيقوم بتخطي جميع الـ Middleware والمسارات العادية التالية وينتقل مباشرة إلى **أول Middleware لمعالجة الأخطاء** يجده.

**مثال:**
```javascript
const fs = require('fs');

app.get('/read-file', (req, res, next) => {
  fs.readFile('/file-that-does-not-exist.txt', (err, data) => {
    if (err) {
      // مرر الخطأ إلى سلسلة معالجة الأخطاء في Express
      return next(err);
    }
    res.send(data);
  });
});
```

---
### ⚙️ 3. كتابة Middleware مخصص للأخطاء
هذه هي الطريقة الأفضل لإنشاء مكان مركزي للتعامل مع جميع أخطاء تطبيقك.

**الصيغة الخاصة:** دالة Middleware معالجة الأخطاء هي دالة خاصة لأنها تأخذ **أربعة معاملات** بدلاً من ثلاثة: `(err, req, res, next)`.
**الموقع:** يجب وضع هذه الدالة **في نهاية** ملفك، بعد تعريف جميع المسارات والـ Middleware الأخرى.

**مثال: معالج أخطاء مركزي**
```javascript
// ... جميع مساراتك والـ Middleware العادية هنا ...

// Middleware لمعالجة الأخطاء (يجب أن يحتوي على 4 معاملات)
app.use((err, req, res, next) => {
  // نطبع تفاصيل الخطأ في الطرفية لأغراض التصحيح
  console.error(err.stack);

  // نرسل استجابة خطأ موحدة بصيغة JSON
  res.status(500).send({
    status: 'error',
    message: 'Something went wrong on the server!'
  });
});
```
هذا يضمن أن جميع الأخطاء في تطبيقك ستؤدي إلى استجابة JSON متسقة بدلاً من صفحة HTML الافتراضية للخطأ.

---
### ❓ 4. التعامل مع أخطاء 404 (غير موجود)
طلب صفحة غير موجودة لا يعتبر "خطأ" برمجيًا، بل هو ببساطة طلب لم يجد أي مسار يتطابق معه. للتعامل مع هذا، نضع دالة Middleware عادية (بثلاثة معاملات) في نهاية سلسلة المسارات (ولكن **قبل** معالج الأخطاء الرئيسي).

**مثال:**
```javascript
// ... جميع مساراتك هنا ...
// app.get('/', ...)
// app.get('/about', ...)

// إذا لم يتطابق أي من المسارات السابقة، سيصل الطلب إلى هنا
app.use((req, res, next) => {
  res.status(404).send("Sorry, we can't find that page!");
});

// معالج الأخطاء الرئيسي يأتي بعد معالج 404
app.use((err, req, res, next) => {
  // ...
});
```
---
